[
    {
        "id": "69345ed8c4c13255",
        "type": "subflow",
        "name": "Loridane - CSV Export",
        "info": "",
        "category": "Loridane",
        "in": [
            {
                "x": 240,
                "y": 180,
                "wires": [
                    {
                        "id": "06788427bde848a3"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#3FADB5",
        "icon": "node-red/file-in.svg"
    },
    {
        "id": "06788427bde848a3",
        "type": "function",
        "z": "69345ed8c4c13255",
        "name": "Load Files",
        "func": "const fs = global.get(\"fs\");\nconst homepath = global.get(\"LORIDANE.settings.path.database\");\nlet files = [];\nlet pathes = [];\n\nfunction traverseDir(dir) {\n    if(dir[dir.length-1]!= \"/\") dir = dir+\"/\";\n        fs.readdirSync(dir).forEach(file => {\n        let fullPath = dir+file;\n        \n        if (fs.lstatSync(fullPath).isDirectory()) {\n            traverseDir(fullPath);\n        } else {\n            files.push(file.replace(\".json\",\"\"));\n            pathes.push(fullPath)\n        }  \n   });\n   return pathes;\n}\n\ntraverseDir(homepath);\nmsg.files = files;\nmsg.pathes = pathes;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 160,
        "wires": [
            [
                "c25fe67afc2bd567",
                "40ea27940353c873"
            ]
        ]
    },
    {
        "id": "40ea27940353c873",
        "type": "function",
        "z": "69345ed8c4c13255",
        "name": "export to CSV",
        "func": "\tconst fs = global.get(\"fs\");\n\tconst homepath = global.get(\"LORIDANE.settings.path.database\");\n\tconst files = msg.files;\n\tconst pathes = msg.pathes;\n\tlet content = {};\n\tconst delimiter = global.get(\"LORIDANE.settings.csvDelimiter\")\n\t// foos-------------------------------------------------\n\tfunction parseJSON(str) {\n\t   try {\n\t      return JSON.parse(str);\n\t   }\n\t   catch (e) {\n\t      //node.warn(e);\n\t      return;\n\t   }\n\t}\n\t\n\tfunction getFirstLine(obj){\n\t    let props = Object.keys(obj);\n\t    return props.join(';')+'\\n';\n\t}\n\t\n\tfunction readFile2Arr(path){\n\t    let output = [];\n\t    let lines;\n\t    const fs = global.get(\"fs\");\n\t    try {\n\t        lines = fs.readFileSync(path).toString().split(\"\\n\");\n\t    }\n\t    catch (e){\n\t        node.warn(e);\n\t        return;\n\t    }\n\t    \n\t    for(let line of lines){\n\t        output.push(parseJSON(line));\n\t    }\n\t    return output;\n\t}\n\t\n\tfunction makeCSV(line){\n\t    let output = '';\n\t    let arr;\n\t    try{\n\t        arr = Object.values(line);\n\t    }\n\t    catch(e){\n\t        return;\n\t    }\n\t    \n\t    output = arr.join(delimiter);\n\t    return output + '\\n';\n\t}\n\t\n\tfunction * readFiles(pathes, files){\n\t    let len = files.length;\n\t    for (let path in pathes){\n\t        let fileContent = readFile2Arr(pathes[path]);\n\t        \n\t        let firstLine = getFirstLine(fileContent[0]);\n\t        let file = firstLine;\n\t        for (let line of fileContent){\n\t            file += makeCSV(line);\n\t        }\n\t        yield {name:files[path]+'.csv',content:file,stateQuo:`Processing File ${parseInt(path)+1} of ${len}.`};\n\t    }\n\t}\n\t//foos end----------------------------------------------------\n\tlet read = readFiles(pathes,files);\n\t\n\tcontent = read.next();\n\twhile (!content.done) {\n\t        node.send({topic:content.value.stateQuo,toast:true});\n\t        fs.writeFileSync(homepath+content.value.name,content.value.content);\n\t        content = read.next();\n\t}\n\tnode.send({topic: `All Files exported to CSV. They are in ${homepath}`,toast:false});\n\t\n\treturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 160,
        "wires": [
            [
                "557f4e4957f485c9"
            ]
        ]
    },
    {
        "id": "3661e3d9a3c9ca57",
        "type": "ui_toast",
        "z": "69345ed8c4c13255",
        "position": "top right",
        "displayTime": "5",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "Toast Notification",
        "x": 930,
        "y": 160,
        "wires": []
    },
    {
        "id": "c25fe67afc2bd567",
        "type": "debug",
        "z": "69345ed8c4c13255",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 530,
        "y": 100,
        "wires": []
    },
    {
        "id": "48e1ec0e129b27d9",
        "type": "switch",
        "z": "69345ed8c4c13255",
        "name": "",
        "property": "toast",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 795,
        "y": 140,
        "wires": [
            [
                "8c2e6ec2ea15bed3"
            ],
            [
                "3661e3d9a3c9ca57"
            ]
        ],
        "l": false
    },
    {
        "id": "8c2e6ec2ea15bed3",
        "type": "ui_toast",
        "z": "69345ed8c4c13255",
        "position": "dialog",
        "displayTime": "5",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "Finished",
        "x": 900,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "03e6eb7dd415a68e",
        "type": "comment",
        "z": "69345ed8c4c13255",
        "name": "CSV Data Export",
        "info": "",
        "x": 270,
        "y": 80,
        "wires": []
    },
    {
        "id": "557f4e4957f485c9",
        "type": "change",
        "z": "69345ed8c4c13255",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "topic",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "topic",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 715,
        "y": 140,
        "wires": [
            [
                "48e1ec0e129b27d9"
            ]
        ],
        "l": false
    },
    {
        "id": "70c78cdd2a465aeb",
        "type": "subflow",
        "name": "LORIDANE - Block/Unblock Nodes",
        "info": "",
        "category": "Loridane",
        "in": [
            {
                "x": 280,
                "y": 180,
                "wires": [
                    {
                        "id": "3705e1e876de47c6"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 720,
                "y": 180,
                "wires": [
                    {
                        "id": "3705e1e876de47c6",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {
            "module": "LORIDANE Block/Unblock Nodes"
        },
        "color": "#3FADB5",
        "icon": "node-red-contrib-throttle/throttle.png"
    },
    {
        "id": "f1febfb44eaf1004",
        "type": "comment",
        "z": "70c78cdd2a465aeb",
        "name": "block nodes from sending",
        "info": "",
        "x": 207,
        "y": 82,
        "wires": []
    },
    {
        "id": "3705e1e876de47c6",
        "type": "function",
        "z": "70c78cdd2a465aeb",
        "name": "build blocksend payload",
        "func": "const gws = global.get(\"LORIDANE.devices.gw\");\n\nfunction senddelayed(msg){\n    node.send(msg);\n}\nlet prompt;\nlet toast;\nlet outString;\nif (msg.payload){\n    outString = 'cn:BL:1';\n    prompt = 'Nodes are now Blocked until you unblock them!';\n    toast = false;\n} else {\n    outString = 'cn:BL:0';\n    toast = true;\n    prompt = 'Nodes Unblocked';\n}\n\ntime = 0;\nadditionalDelay = 50;\n\nfor (let gw in gws) {\n    obj = {payload: outString, topic:`lora/${gws[gw].uid}`};\n    setTimeout(senddelayed,time,obj);\n}\nnode.send({prompt:prompt, toast:toast});\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 180,
        "wires": [
            [
                "fb014c4109f6fd93"
            ]
        ]
    },
    {
        "id": "4e02c079c3dd057a",
        "type": "ui_toast",
        "z": "70c78cdd2a465aeb",
        "position": "top right",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "",
        "x": 890,
        "y": 100,
        "wires": []
    },
    {
        "id": "fb014c4109f6fd93",
        "type": "switch",
        "z": "70c78cdd2a465aeb",
        "name": "",
        "property": "toast",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 695,
        "y": 140,
        "wires": [
            [
                "79d0e9342f069c29"
            ],
            [
                "02ebf361d076835c"
            ]
        ],
        "l": false
    },
    {
        "id": "1eb95e652ee56af7",
        "type": "ui_toast",
        "z": "70c78cdd2a465aeb",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "",
        "x": 890,
        "y": 171,
        "wires": [
            []
        ]
    },
    {
        "id": "79d0e9342f069c29",
        "type": "change",
        "z": "70c78cdd2a465aeb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "prompt",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 755,
        "y": 100,
        "wires": [
            [
                "4e02c079c3dd057a"
            ]
        ],
        "l": false
    },
    {
        "id": "02ebf361d076835c",
        "type": "change",
        "z": "70c78cdd2a465aeb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "prompt",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 775,
        "y": 160,
        "wires": [
            [
                "1eb95e652ee56af7"
            ]
        ],
        "l": false
    },
    {
        "id": "b5aa0f5765475d21",
        "type": "subflow",
        "name": "MQTT Forwarder",
        "info": "",
        "category": "Loridane",
        "in": [
            {
                "x": 200,
                "y": 120,
                "wires": [
                    {
                        "id": "3126adbea28f66af"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 840,
                "y": 120,
                "wires": [
                    {
                        "id": "80c1923731d9fae4",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#3FADB5",
        "icon": "font-awesome/fa-paper-plane"
    },
    {
        "id": "3126adbea28f66af",
        "type": "function",
        "z": "b5aa0f5765475d21",
        "name": "analyse payload",
        "func": "if(msg.payload[0] == \"+\"){\n    return;\n}\n\nlet pay = [];\nlet payloadobject = {};\nconst fullData = msg.data;\n\nif(typeof(msg.payload) != \"number\"){\n    if (msg.payload.includes(\";\")){\n        pay = msg.payload.split(\";\");    \n    }else{\n        pay[0] = msg.payload;\n    }\n}else{\n     pay[0] = msg.payload;\n}\n\n// split payloads to  measure0, measure1,....and so on\nlet i = 0;\nfor(let val of pay){\n    if(typeof(val) == \"number\"){\n        val = parseFloat(val);\n    }\n    payloadobject[`measure${i}`] = val;\n    i++;\n}\n\nmsg.payload = {...payloadobject, ...fullData};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 120,
        "wires": [
            [
                "80c1923731d9fae4"
            ]
        ]
    },
    {
        "id": "80c1923731d9fae4",
        "type": "function",
        "z": "b5aa0f5765475d21",
        "name": "Set DataSet",
        "func": "let data = msg.data\nlet time = new Date(data.lastSeen)||new Date.now();\nlet showtime = time.toLocaleString(\"de-DE\");\nlet date = time.toISOString().substr(0,7);\n\nmsg.payload.time = showtime;\nmsg.payload.timestamp = data.lastSeen;\ndelete msg.payload.lastSeen;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 120,
        "wires": [
            [
                "84383d973c491d60",
                "c0a3aa7bc8ce6775"
            ]
        ]
    },
    {
        "id": "84383d973c491d60",
        "type": "mqtt out",
        "z": "b5aa0f5765475d21",
        "name": "Forward Msg",
        "topic": "loridane/forwarded/",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3be33484.0e776c",
        "x": 730,
        "y": 160,
        "wires": []
    },
    {
        "id": "c0a3aa7bc8ce6775",
        "type": "function",
        "z": "b5aa0f5765475d21",
        "d": true,
        "name": "set OPC_UA Parameters",
        "func": "return;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 220,
        "wires": [
            [
                "209a8f28dc1f12d2"
            ]
        ]
    },
    {
        "id": "209a8f28dc1f12d2",
        "type": "OpcUa-Client",
        "z": "b5aa0f5765475d21",
        "d": true,
        "endpoint": "",
        "action": "write",
        "deadbandtype": "a",
        "deadbandvalue": 1,
        "time": 10,
        "timeUnit": "s",
        "certificate": "n",
        "localfile": "",
        "localkeyfile": "",
        "securitymode": "None",
        "securitypolicy": "None",
        "name": "",
        "x": 940,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "b9c36c50122d3534",
        "type": "subflow",
        "name": "USB Gatweay Config",
        "info": "",
        "category": "Loridane",
        "in": [],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#3FADB5",
        "icon": "node-red-dashboard/ui_dropdown.png"
    },
    {
        "id": "165abd08ab5997d3",
        "type": "serial in",
        "z": "b9c36c50122d3534",
        "name": "Listen to device",
        "serial": "d726f7d4.e188a8",
        "x": 100,
        "y": 160,
        "wires": [
            [
                "489395b840d57d55",
                "20afc46063fc460e",
                "d0db093491b0175f"
            ]
        ]
    },
    {
        "id": "9443f601f2e54a8b",
        "type": "serial out",
        "z": "b9c36c50122d3534",
        "name": "Write to device",
        "serial": "d726f7d4.e188a8",
        "x": 840,
        "y": 200,
        "wires": []
    },
    {
        "id": "489395b840d57d55",
        "type": "function",
        "z": "b9c36c50122d3534",
        "name": "parse serial input stream",
        "func": "trigger = msg.payload;\n//trigger.replace(/\\r\\n|\\r|\\n/g,\"\")\nmsg = {payload: trigger};\n\ncases = [\n    \"Please Enter Your WiFi-SSID\",\n    \"Please Enter Your WiFi-Password\",\n    \"Please Enter the Address Of Your MQTT Broker without the Port\",\n    \"Please Enter the Username Of Your MQTT Broker\",\n    \"Please Enter the Password for Your MQTT Broker\",\n    ]\n    \nlet autoOutput;\nfor(let pat in cases){\n    if (trigger.includes(cases[pat])){\n        let gatewayConfig = global.get(\"LORIDANE.settings.gatewayConfig\") || {};\n        if (gatewayConfig != {} && gatewayConfig.automatic){\n            let autoOutput = '';\n            node.warn('Gateway Auto Configuration')\n            switch(pat){\n                case \"0\":\n                    autoOutput = gatewayConfig.ssid+'\\n';\n                    break;\n                case \"1\":\n                    autoOutput = gatewayConfig.wpwd+'\\n';\n                    break;\n                case \"2\":\n                    autoOutput = gatewayConfig.broker+'\\n';\n                    break;\n                case \"3\":\n                    autoOutput = gatewayConfig.user+'\\n';\n                    break;\n                case \"4\":\n                    autoOutput = gatewayConfig.mpwd+'\\n';\n                    break;\n                default:\n                    node.warn('no case met')\n                    return;\n            }\n            return [null,{payload:autoOutput}];\n        }\n        return [msg,null];\n    }else{\n        continue;  \n    }\n}\nreturn;",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 180,
        "wires": [
            [
                "2025553245eafb29",
                "0081140cd5374547"
            ],
            [
                "9443f601f2e54a8b"
            ]
        ]
    },
    {
        "id": "53bfad030d9cd90a",
        "type": "ui_toast",
        "z": "b9c36c50122d3534",
        "position": "prompt",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "Cancel",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "Input Dialog Creds",
        "x": 610,
        "y": 160,
        "wires": [
            [
                "9443f601f2e54a8b",
                "2025553245eafb29"
            ]
        ]
    },
    {
        "id": "a1af85d35eb7dacf",
        "type": "ui_button",
        "z": "b9c36c50122d3534",
        "name": "",
        "group": "4073e498fd9f7db7",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "WiFi Credentials",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "wifi",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 660,
        "y": 120,
        "wires": [
            [
                "9443f601f2e54a8b"
            ]
        ]
    },
    {
        "id": "6525c9359d920c7a",
        "type": "ui_button",
        "z": "b9c36c50122d3534",
        "name": "",
        "group": "4073e498fd9f7db7",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "MQTT Credentials",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "mqtt",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 670,
        "y": 80,
        "wires": [
            [
                "9443f601f2e54a8b"
            ]
        ]
    },
    {
        "id": "20afc46063fc460e",
        "type": "debug",
        "z": "b9c36c50122d3534",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 330,
        "y": 60,
        "wires": []
    },
    {
        "id": "2025553245eafb29",
        "type": "debug",
        "z": "b9c36c50122d3534",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 790,
        "y": 300,
        "wires": []
    },
    {
        "id": "d0db093491b0175f",
        "type": "function",
        "z": "b9c36c50122d3534",
        "name": "Confirmation",
        "func": "trigger = msg.payload;\n//trigger.replace(/\\r\\n|\\r|\\n/g,\"\")\n\nmsg = {payload: trigger, topic: \"Answer:\"};\nif(trigger.includes(\"Message arrived\"))return;\ncases = [\n    \", IP address:\",\n    \"Please Enter Your WiFi-Password\",\n    \"[WIFI] Connecting to\",\n    \"MQTT Credentials updated\",\n    \"Subscribing to topic:\",\n    \"lora/GW\"\n    ]\n\nfor(var pat of cases){\n    if (trigger.includes(pat)){\n        return msg;\n    }else{\n        continue;  \n    }\n}\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 230,
        "y": 240,
        "wires": [
            [
                "7909a4c4cc9cbfb7"
            ]
        ]
    },
    {
        "id": "7909a4c4cc9cbfb7",
        "type": "ui_toast",
        "z": "b9c36c50122d3534",
        "position": "top right",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "",
        "x": 270,
        "y": 300,
        "wires": []
    },
    {
        "id": "0081140cd5374547",
        "type": "function",
        "z": "b9c36c50122d3534",
        "name": "filter null msg",
        "func": "if (msg === null){\n    return;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 475,
        "y": 160,
        "wires": [
            [
                "53bfad030d9cd90a"
            ]
        ],
        "l": false
    },
    {
        "id": "e604d18b909fb87d",
        "type": "debug",
        "z": "b9c36c50122d3534",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 610,
        "y": 360,
        "wires": []
    },
    {
        "id": "d726f7d4.e188a8",
        "type": "serial-port",
        "serialport": "/dev/ttyUSB0",
        "serialbaud": "115200",
        "databits": "8",
        "parity": "none",
        "stopbits": "1",
        "waitfor": "",
        "dtr": "none",
        "rts": "none",
        "cts": "none",
        "dsr": "none",
        "newline": "\\n",
        "bin": "false",
        "out": "char",
        "addchar": "",
        "responsetimeout": "10000"
    },
    {
        "id": "4073e498fd9f7db7",
        "type": "ui_group",
        "name": "Change Gateway Settings via USB",
        "tab": "1809f267.7a279e",
        "order": 6,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "f74e4d3b7750f42f",
        "type": "subflow",
        "name": "Write to Database",
        "info": "",
        "category": "Loridane",
        "in": [
            {
                "x": 180,
                "y": 180,
                "wires": [
                    {
                        "id": "e5410fa4.8b429"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#3FADB5",
        "icon": "node-red-dashboard/ui_chart.png",
        "status": {
            "x": 800,
            "y": 300,
            "wires": [
                {
                    "id": "f17a47f02ba50177",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "e5410fa4.8b429",
        "type": "function",
        "z": "f74e4d3b7750f42f",
        "name": "analyse payload",
        "func": "if(msg.payload[0] == \"+\"){\n    return;\n}\n\nlet pay = [];\nlet payloadobject = {};\n\nif(typeof(msg.payload) != \"number\"){\n    if (msg.payload.includes(\";\")){\n        pay = msg.payload.split(\";\");    \n    }else{\n        pay[0] = msg.payload;\n    }\n}else{\n     pay[0] = msg.payload;\n}\n\n// split payloads to  measure0, measure1,....and so on\nlet i = 0;\nfor(let val of pay){\n    if(num = parseFloat(val), typeof(num) == \"number\"){\n        val = num;\n    }\n    payloadobject[`measure${i}`] = val;\n    i++;\n}\nmsg.payload = payloadobject;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 180,
        "wires": [
            [
                "11d81530.cba6ab"
            ]
        ],
        "info": "parses the raw payload and returns a corract json formatting"
    },
    {
        "id": "11d81530.cba6ab",
        "type": "function",
        "z": "f74e4d3b7750f42f",
        "name": "Set DataSet",
        "func": "let data = msg.data\nconst UID = data.node;\nlet time = new Date(data.lastSeen)||new Date.now();\nlet showtime = time.toLocaleString(\"de-DE\");\nlet date = time.toISOString().substr(0,7);\nconst USER = global.get(\"LORIDANE.LinuxUsername\");\n\nmsg.payload.time = showtime;\nmsg.payload.timestamp = data.lastSeen;\nmsg.payload.uid = UID;\n\nif(msg.payload !== null)msg.filename = `/home/${USER}/LORIDANE/database/${UID}/${UID}_${date}.json`;\nmsg.dir = `/home/${USER}/LORIDANE/database/${UID}`;\nglobal.set(`LORIDANE.data.${UID}.lastreading`,msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 180,
        "wires": [
            [
                "40c4880ff2097a1c"
            ]
        ],
        "info": "set up the dataset for the database"
    },
    {
        "id": "92174b3b.9e10f8",
        "type": "switch",
        "z": "f74e4d3b7750f42f",
        "name": "filter",
        "property": "data.node",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "NO94B97EC0C46C",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 310,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "114959bf99688411",
        "type": "debug",
        "z": "f74e4d3b7750f42f",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 120,
        "wires": []
    },
    {
        "id": "f87ec9a8d00816bc",
        "type": "comment",
        "z": "f74e4d3b7750f42f",
        "name": "Write input data to files",
        "info": "",
        "x": 370,
        "y": 80,
        "wires": []
    },
    {
        "id": "2b71bd33fe1bfb21",
        "type": "comment",
        "z": "f74e4d3b7750f42f",
        "name": "connect switch into gap to filter particular nodes",
        "info": "",
        "x": 440,
        "y": 240,
        "wires": []
    },
    {
        "id": "f17a47f02ba50177",
        "type": "status",
        "z": "f74e4d3b7750f42f",
        "name": "",
        "scope": [
            "30afd728.c964c8"
        ],
        "x": 690,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "40c4880ff2097a1c",
        "type": "function",
        "z": "f74e4d3b7750f42f",
        "name": "write dataset to File",
        "func": "const fs = global.get(\"fs\");\nconst dir = msg.dir;\ntry{\n    fs.appendFile(msg.filename, JSON.stringify(msg.payload)+'\\n', err => {\n    if (err) node.warn(err);\n    if (!fs.existsSync(dir)){\n        fs.mkdirSync(dir); //if not existant make a node directory\n        fs.appendFileSync(msg.filename,JSON.stringify(msg.payload)+'\\n');\n    }\n    });\n    \n}catch(err) {\n    node.warn(err)\n    fs.writeFileSync(msg.filename, JSON.stringify(msg.payload)+'\\n');\n}\n  //file written successfully\nnode.status({text:msg.filename});\nreturn msg;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 180,
        "wires": []
    },
    {
        "id": "d7577d7f.0f9b4",
        "type": "subflow",
        "name": "LORIDANE - GUI Messages",
        "info": "",
        "category": "Loridane",
        "in": [
            {
                "x": 120,
                "y": 140,
                "wires": [
                    {
                        "id": "cfe970e8.dec84"
                    },
                    {
                        "id": "600536c1.7e8cc8"
                    },
                    {
                        "id": "04de0d0b8bcf8885"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#3FADB5",
        "icon": "node-red/envelope.svg"
    },
    {
        "id": "cfe970e8.dec84",
        "type": "function",
        "z": "d7577d7f.0f9b4",
        "name": "Read incoming messages",
        "func": "/*\nfunction getLocaleTime(dateobj){ //return corrected summer or wintertime\n    month = dateobj.getMonth();\n    hours = dateobj.getHours();\n    \n    //Between April an September?\n    if (inRangeOf(month,3,8)){\n        dateobj.setHours(++hours);\n        return dateobj;\n    }\n    \n    daydate = dateobj.getDate();\n    day = dateobj.getDay();\n    if (month == 2){ //if in March\n        if (daydate >= 25 && 31 - day > 25){\n            dateobj.setHours(++hours);\n            return dateobj;\n        }\n    }\n    if (month == 9){ //if in October\n        if (daydate >= 25 && 31 - day > 25){\n            return dateobj;\n        }else{\n            dateobj.setHours(++hours);\n            return dateobj;\n        }\n    }\n    return dateobj;\n}\n//*/\ninRangeOf = global.get(\"LORIDANE.funcs.inRangeOf\");\n\nif(msg.topic == \"clear\"){\n    lastmsgs = [\"\",\"\",\"\",\"\",\"\"];\n    context.set(\"lastmsgs\",lastmsgs);\n    msg = {payload: lastmsgs};\n    return msg;\n}\n\npay = msg.data.pay;\nnode = msg.data.node;\nrssi = msg.data.rssi;\nnow = new Date();//getLocaleTime(new Date());\nlastmsgs = context.get(\"lastmsgs\")||[];\ninput = node+\" - \"+pay +\" - RSSI: \"+rssi +\" - \"+ now.toLocaleString('de-DE');\n\nlastmsgs.unshift(input);\nif (lastmsgs.length > 5) lastmsgs.pop();\ncontext.set(\"lastmsgs\",lastmsgs);\n\nmsg = {payload: lastmsgs};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 140,
        "wires": [
            [
                "1d74e338.18182d",
                "afbef3a7.eda7",
                "2a6b272a.71f028",
                "a11f3649.f42108",
                "1f214329.8b0e6d"
            ]
        ],
        "info": "writes last 5 messages to th ui"
    },
    {
        "id": "1d74e338.18182d",
        "type": "ui_text",
        "z": "d7577d7f.0f9b4",
        "group": "3458ce4.31e1d32",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "Last Msgs",
        "label": "{{msg.payload[0]}}",
        "format": "",
        "layout": "col-center",
        "x": 490,
        "y": 80,
        "wires": []
    },
    {
        "id": "afbef3a7.eda7",
        "type": "ui_text",
        "z": "d7577d7f.0f9b4",
        "group": "3458ce4.31e1d32",
        "order": 3,
        "width": 0,
        "height": 0,
        "name": "Last Msgs",
        "label": "{{msg.payload[1]}}",
        "format": "",
        "layout": "col-center",
        "x": 530,
        "y": 120,
        "wires": []
    },
    {
        "id": "2a6b272a.71f028",
        "type": "ui_text",
        "z": "d7577d7f.0f9b4",
        "group": "3458ce4.31e1d32",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "Last Msgs",
        "label": "{{msg.payload[2]}}",
        "format": "",
        "layout": "col-center",
        "x": 550,
        "y": 160,
        "wires": []
    },
    {
        "id": "a11f3649.f42108",
        "type": "ui_text",
        "z": "d7577d7f.0f9b4",
        "group": "3458ce4.31e1d32",
        "order": 5,
        "width": 0,
        "height": 0,
        "name": "Last Msgs",
        "label": "{{msg.payload[3]}}",
        "format": "",
        "layout": "col-center",
        "x": 590,
        "y": 200,
        "wires": []
    },
    {
        "id": "1f214329.8b0e6d",
        "type": "ui_text",
        "z": "d7577d7f.0f9b4",
        "group": "3458ce4.31e1d32",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "Last Msgs",
        "label": "{{msg.payload[4]}}",
        "format": "",
        "layout": "col-center",
        "x": 650,
        "y": 240,
        "wires": []
    },
    {
        "id": "d41ccc5b.708d4",
        "type": "ui_button",
        "z": "d7577d7f.0f9b4",
        "name": "",
        "group": "3458ce4.31e1d32",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Clear View",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "fa-trash-o",
        "payload": "",
        "payloadType": "str",
        "topic": "clear",
        "topicType": "str",
        "x": 260,
        "y": 100,
        "wires": [
            [
                "cfe970e8.dec84"
            ]
        ]
    },
    {
        "id": "600536c1.7e8cc8",
        "type": "function",
        "z": "d7577d7f.0f9b4",
        "name": "gui show confirmed",
        "func": "if(msg.data.pay == \"+\")return {topic:\"Confirmed by:\",payload:msg.data.node};\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 210,
        "y": 280,
        "wires": [
            [
                "fa6e0a11.0493b8"
            ]
        ],
        "info": "show a toas message id a device confirmed a configuration"
    },
    {
        "id": "fa6e0a11.0493b8",
        "type": "ui_toast",
        "z": "d7577d7f.0f9b4",
        "position": "top right",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "topic": "",
        "name": "show GUI Confirmation",
        "x": 440,
        "y": 280,
        "wires": []
    },
    {
        "id": "82015455d437d826",
        "type": "ui_table",
        "z": "d7577d7f.0f9b4",
        "group": "3458ce4.31e1d32",
        "name": "Incoming Data",
        "order": 9,
        "width": "18",
        "height": "8",
        "columns": [],
        "outputs": 0,
        "cts": false,
        "x": 840,
        "y": 500,
        "wires": []
    },
    {
        "id": "aca2a067f7c14a0a",
        "type": "function",
        "z": "d7577d7f.0f9b4",
        "name": "read directory",
        "func": "const databasePath = global.get(\"LORIDANE.settings.path.database\");\nconst fs = global.get(\"fs\");\nlet files = [];\nlet pathes = [];\n\nif (!databasePath){\n    const loadConfig = global.get(\"LORIDANE.funcs.loadConfig\");\n    user = global.get(\"LORIDANE.LinuxUsername\");\n    path = `/home/${user}/LORIDANE/config/`;\n    loadConfig(user,path);\n}\n\n//--------------------------\nfunction traverseDir(dir) {\n    if(dir[dir.length-1]!= \"/\") dir = dir+\"/\";\n        fs.readdirSync(dir).forEach(file => {\n        let fullPath = dir+file;\n        \n        if (fs.lstatSync(fullPath).isDirectory()) {\n            traverseDir(fullPath);\n        } else {\n            files.push(file.replace(\".json\",\"\"));\n            pathes.push(fullPath)\n        }  \n   });\n   return pathes;\n}\n//--------------------------\n\n\ntraverseDir(databasePath);\njsons = [];\n\nfor (let file of pathes){\n    if(file.endsWith(\".json\")){\n        jsons.push(file);\n    }\n}\n\nmsg.filePaths = jsons;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 460,
        "wires": [
            [
                "7ac36e992ff6e17a"
            ]
        ],
        "info": "get the file from the database"
    },
    {
        "id": "c8031ef90f17bdf7",
        "type": "debug",
        "z": "d7577d7f.0f9b4",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 590,
        "y": 400,
        "wires": []
    },
    {
        "id": "7ac36e992ff6e17a",
        "type": "function",
        "z": "d7577d7f.0f9b4",
        "name": "get tail of every file",
        "func": "let tailLen;\nif(msg.topic == \"tailLen\"){\n    context.set(\"tailLen\", msg.payload);\n    return;\n}else{\n    tailLen = context.get(\"tailLen\")||\"5\";\n}\n\nfor(let path of msg.filePaths){\n    node.send({path:`tail -${tailLen} ${path}`, topic: false})\n    //node.warn(path)\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 520,
        "wires": [
            [
                "1a0460b0be60f5db"
            ]
        ]
    },
    {
        "id": "380320e9e2346798",
        "type": "exec",
        "z": "d7577d7f.0f9b4",
        "command": "",
        "addpay": "path",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "tail file ends from database",
        "x": 540,
        "y": 580,
        "wires": [
            [
                "f3d923e18e539d3a"
            ],
            [],
            []
        ]
    },
    {
        "id": "f9da180cb6c4e409",
        "type": "function",
        "z": "d7577d7f.0f9b4",
        "name": "parse json and write file to object",
        "func": "dataArr = context.get(\"dataArr\") || [];\n\nif(msg.path !== undefined){\n    lastDevice = msg.path.split(\"/\")\n    lastDevice = lastDevice[lastDevice.length -2]\n    context.set(\"lastDevice\",lastDevice);\n}else{\n    lastDevice = context.get(\"lastDevice\")\n}\n\nif (msg.payload !== \"\" && msg.payload !== undefined){\n    lastLines = msg.payload.split(\"\\n\")\n    lastLines.splice(lastLines.length-1,1);\n    for (let line of lastLines){\n        obj = {Device:lastDevice, ...JSON.parse(line)}\n        dataArr.push(obj);\n    }\n    context.set(\"dataArr\",dataArr);\n}\n\nif(msg.topic === true){\n    context.set(\"dataArr\",[]);\n    node.send({payload:[]});\n    dataArr.sort( function(a,b){return b.timestamp - a.timestamp} );\n    return {payload: dataArr};\n}\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 560,
        "wires": [
            [
                "82015455d437d826"
            ]
        ],
        "info": "parse the stringified json from file to an object and show it in the ui table"
    },
    {
        "id": "04de0d0b8bcf8885",
        "type": "function",
        "z": "d7577d7f.0f9b4",
        "name": "filter msgs < 30 seconds",
        "func": "const now = Date.now()\nconst lasttime = context.get(\"lasttime\") || now;\nlet interval = now - lasttime;\nlet timer = context.get(\"timer\");\nclearTimeout(timer);\ncontext.set(\"timer\",timer);\nsetTimeout(()=>node.status({}),5000);\n\nif(interval <= 30000){\n    timer = setTimeout(()=>{\n        node.send({payload:now});\n        node.status({text:\"Table Updated\"})\n        },\n        30000)\n    context.set(\"timer\",timer);\n    node.status({text:\"Msg Filtered\"})\n    return;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 175,
        "y": 460,
        "wires": [
            [
                "aca2a067f7c14a0a"
            ]
        ],
        "icon": "node-red-contrib-throttle/throttle.png",
        "l": false,
        "info": "filters messages if the time in between is smaller that 30 secs\nso the ui table does not update that often"
    },
    {
        "id": "3474282182622796",
        "type": "ui_button",
        "z": "d7577d7f.0f9b4",
        "name": "",
        "group": "3458ce4.31e1d32",
        "order": 8,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "UPDATE TABLE",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "",
        "payloadType": "date",
        "topic": "topic",
        "topicType": "msg",
        "x": 340,
        "y": 420,
        "wires": [
            [
                "aca2a067f7c14a0a"
            ]
        ]
    },
    {
        "id": "453ef5400f2519f0",
        "type": "ui_dropdown",
        "z": "d7577d7f.0f9b4",
        "name": "how many historic values",
        "label": "Amount of historic values",
        "tooltip": "",
        "place": "How many per device?",
        "group": "3458ce4.31e1d32",
        "order": 7,
        "width": 0,
        "height": 0,
        "passthru": true,
        "multiple": false,
        "options": [
            {
                "label": "",
                "value": "5",
                "type": "str"
            },
            {
                "label": "",
                "value": 1,
                "type": "num"
            },
            {
                "label": "",
                "value": "2",
                "type": "str"
            },
            {
                "label": "",
                "value": "10",
                "type": "str"
            },
            {
                "label": "",
                "value": "20",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "tailLen",
        "topicType": "str",
        "className": "",
        "x": 170,
        "y": 520,
        "wires": [
            [
                "7ac36e992ff6e17a"
            ]
        ]
    },
    {
        "id": "1a0460b0be60f5db",
        "type": "switch",
        "z": "d7577d7f.0f9b4",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 555,
        "y": 520,
        "wires": [
            [
                "f9da180cb6c4e409",
                "c8031ef90f17bdf7"
            ],
            [
                "380320e9e2346798"
            ]
        ],
        "l": false
    },
    {
        "id": "f3d923e18e539d3a",
        "type": "function",
        "z": "d7577d7f.0f9b4",
        "name": "wait until timeout",
        "func": "let timer = context.get(\"timer\")||null;\nclearTimeout(timer);\n\ncontext.set(\"timer\",setTimeout(() => node.send({topic:true}),200));\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 715,
        "y": 580,
        "wires": [
            [
                "f9da180cb6c4e409"
            ]
        ],
        "l": false
    },
    {
        "id": "3458ce4.31e1d32",
        "type": "ui_group",
        "name": "Messages",
        "tab": "278b2300.ae23ae",
        "order": 1,
        "disp": true,
        "width": "18",
        "collapse": false,
        "className": ""
    },
    {
        "id": "c23de0ef.dae5f",
        "type": "subflow",
        "name": "LORIDANE - NodeSync",
        "info": "",
        "category": "Loridane",
        "in": [],
        "out": [],
        "env": [],
        "meta": {
            "license": "GPL-3.0"
        },
        "color": "#3FADB5",
        "icon": "font-awesome/fa-clock-o",
        "status": {
            "x": 500,
            "y": 220,
            "wires": [
                {
                    "id": "111ba65b.68a45a",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "47d49580.9cf8dc",
        "type": "function",
        "z": "c23de0ef.dae5f",
        "name": "send Sync",
        "func": "//*\ntimer = context.get(\"timer\");\nclearTimeout(timer);\ncontext.set(\"timer\",timer);\n//*/\n\nfunction countup(secs){\n    timer = context.get(\"timer\");\n    clearTimeout(timer);\n    node.status({text:\"Last Sync: \"+secs+\"s ago\"});\n    secs++;\n    timer = setTimeout(countup,1000,secs);\n    context.set(\"timer\",timer);\n}\n\ngetUIDGW = global.get(\"LORIDANE.funcs.getUIDGW\");\ngws = getUIDGW();\n\nfor (var g in gws){\n    msg = {payload:\"cn:sync\",topic:\"lora/\"+gws[g]};\n    node.send(msg);\n}\nnode.status({text: \"Sync\"});\n//*\ntimer = setTimeout(countup,1000,0);\ncontext.set(\"timer\",timer);\n//*/\n//setTimeout(()=>node.status({}),5000);\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 80,
        "wires": [
            [
                "44fa5e0e.309d9"
            ]
        ]
    },
    {
        "id": "44fa5e0e.309d9",
        "type": "subflow:2fad0fdc.1d24b",
        "z": "c23de0ef.dae5f",
        "name": "",
        "env": [],
        "x": 740,
        "y": 80,
        "wires": []
    },
    {
        "id": "a10c5144.a42b1",
        "type": "inject",
        "z": "c23de0ef.dae5f",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "30",
        "topic": "",
        "payloadType": "date",
        "x": 200,
        "y": 80,
        "wires": [
            [
                "b62026e6367c3ae2"
            ]
        ]
    },
    {
        "id": "111ba65b.68a45a",
        "type": "status",
        "z": "c23de0ef.dae5f",
        "name": "",
        "scope": null,
        "x": 390,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "b62026e6367c3ae2",
        "type": "function",
        "z": "c23de0ef.dae5f",
        "name": "set sync interval",
        "func": "const interval = global.get(\"LORIDANE.settings.syncInterval\")||233;\n\nfunction trigger(){\n    node.send({payload:true});\n}\n\nlet intVal = context.get(\"intVal\");\nclearInterval(intVal);\n\nintVal = setInterval(trigger,interval * 1000);\ncontext.set(\"intVal\",intVal);\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 80,
        "wires": [
            [
                "47d49580.9cf8dc"
            ]
        ]
    },
    {
        "id": "922120e5.5b086",
        "type": "subflow",
        "name": "LORIDANE - GUI",
        "info": "",
        "category": "Loridane",
        "in": [
            {
                "x": 40,
                "y": 460,
                "wires": [
                    {
                        "id": "fa0f21a7.2fba9"
                    },
                    {
                        "id": "f2230676.6a28f8"
                    },
                    {
                        "id": "60d33b08.42a134"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1440,
                "y": 460,
                "wires": [
                    {
                        "id": "53654a49.b88fe4",
                        "port": 0
                    },
                    {
                        "id": "1733b022.f7d1a",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {
            "license": "GPL-3.0"
        },
        "color": "#3FADB5",
        "icon": "node-red-dashboard/ui_button.png"
    },
    {
        "id": "34e37a28.b9b3f6",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "",
        "group": "d7396f84.84707",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Reboot Server",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "",
        "payload": "Are You Sure You Want the Server to Reboot now?",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 320,
        "y": 140,
        "wires": [
            [
                "178cfec4.b5ec91"
            ]
        ]
    },
    {
        "id": "178cfec4.b5ec91",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "Cancel",
        "raw": false,
        "topic": "",
        "name": "",
        "x": 510,
        "y": 140,
        "wires": [
            [
                "1ef5287c.168528"
            ]
        ]
    },
    {
        "id": "1ef5287c.168528",
        "type": "switch",
        "z": "922120e5.5b086",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "OK",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "OK",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 680,
        "y": 140,
        "wires": [
            [
                "62e26b8b.b40d54",
                "47bcec4b.214e74"
            ],
            [
                "b793604.f64eca"
            ]
        ]
    },
    {
        "id": "b793604.f64eca",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "top right",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "Cancel",
        "raw": false,
        "topic": "",
        "name": "Cancelled",
        "x": 890,
        "y": 180,
        "wires": []
    },
    {
        "id": "e41ef28e.13734",
        "type": "exec",
        "z": "922120e5.5b086",
        "command": "sudo reboot now",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "",
        "x": 1010,
        "y": 120,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "8503ba05.ad4498",
        "type": "inject",
        "z": "922120e5.5b086",
        "name": "Reboot",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "5",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 320,
        "y": 100,
        "wires": [
            [
                "e41ef28e.13734"
            ]
        ]
    },
    {
        "id": "ac986b9b.5d8f08",
        "type": "ui_dropdown",
        "z": "922120e5.5b086",
        "name": "Choose Node",
        "label": "",
        "tooltip": "",
        "place": "Select Node to be configured",
        "group": "a3b84e04.bcada",
        "order": 2,
        "width": 11,
        "height": 1,
        "passthru": false,
        "multiple": true,
        "options": [],
        "payload": "",
        "topic": "nodes",
        "topicType": "str",
        "x": 540,
        "y": 900,
        "wires": [
            [
                "d643c272.92077",
                "1fbeb059.389d9"
            ]
        ]
    },
    {
        "id": "fa0f21a7.2fba9",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Load Devices",
        "func": "nodes = global.get(\"LORIDANE.devices.nodes\");\noptions = [];\n\n// as list for the choose device dropdown load the device an if available the friendlyname\nfor (var node in nodes){\n    let name = \"\";\n    if(nodes[node].friendlyname != \"\" && nodes[node].friendlyname != undefined){\n        name = `${nodes[node].uid} - ${nodes[node].friendlyname}`;\n        options[node] = {[name]:nodes[node].uid};\n    }else{\n        name = `${nodes[node].uid}`;\n        options[node] = {[name]:nodes[node].uid} ;\n    }\n}\nreturn {options:options};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 900,
        "wires": [
            [
                "ac986b9b.5d8f08"
            ]
        ]
    },
    {
        "id": "7b8ee05a.b7734",
        "type": "debug",
        "z": "922120e5.5b086",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1030,
        "y": 900,
        "wires": []
    },
    {
        "id": "94f9702b.5ce8a",
        "type": "inject",
        "z": "922120e5.5b086",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 190,
        "y": 860,
        "wires": [
            [
                "fa0f21a7.2fba9"
            ]
        ]
    },
    {
        "id": "d643c272.92077",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Join Configurations",
        "func": "nodes = msg.payload;\nif(msg.topic == \"nodes\"){\n    context.set(\"nodes\",nodes);\n    return;\n}\n\nif(msg.topic == \"data\"){\n    nodes = context.get(\"nodes\");\n    data = msg.payload;\n    data.freq /= 10;\n    data.sf /= 1; \n    data.tx /= 1;\n    data.iv *= 1000;\n}\nmsg.payload = {nodes:nodes,data:data};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 940,
        "wires": [
            [
                "a6dcf1a0.330c5"
            ]
        ]
    },
    {
        "id": "bf73f3fb.d34da",
        "type": "ui_form",
        "z": "922120e5.5b086",
        "name": "",
        "label": "Configure chosen Node(s)",
        "group": "a3b84e04.bcada",
        "order": 4,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "Friendly Name (eg. Milling Center 1)",
                "value": "friendly",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Frequency (8672 for 867.2MHz)",
                "value": "freq",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Spreading Factor (7-12)",
                "value": "sf",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Sending Power (4 - 20)",
                "value": "tx",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Interval (seconds)",
                "value": "iv",
                "type": "text",
                "required": false,
                "rows": null
            }
        ],
        "formValue": {
            "friendly": "",
            "freq": "",
            "sf": "",
            "tx": "",
            "iv": ""
        },
        "payload": "",
        "submit": "Submit",
        "cancel": "Cancel",
        "topic": "data",
        "topicType": "str",
        "splitLayout": "",
        "className": "",
        "x": 470,
        "y": 960,
        "wires": [
            [
                "d643c272.92077"
            ]
        ]
    },
    {
        "id": "a6dcf1a0.330c5",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Validate Data",
        "func": "data = msg.payload.data;\nlet topic = true;\ninrange = global.get(\"LORIDANE.funcs.inRangeOf\");\nconst timeOnAir = global.get(\"LORIDANE.values.lastPayloadLens.toa\");\nlet minInterval = global.get(\"LORIDANE.values.lastPayloadLens.minInterval\") || 5000;\nconst allowed = global.get(\"LORIDANE.funcs.allowed\");\nif(data.freq === 0){\n    data.freq = global.get(\"LORIDANE.devices.gw[0].freq\") / (1e6);\n}\n\nvalidated = false;\nkeys = Object.keys(data);\ncause = \"\";\n\nfor(var key of keys){\n    validated = false;\n    if(data[key]){\n        switch(key){\n            case \"freq\":\n                fromAllowed = allowed(data.freq);\n                validated = fromAllowed.allowed;\n                cause = \"Forbidden Frequency \"+data.freq+\"MHz, try \"+fromAllowed.instead+\" MHz instead\";\n                break;\n            case \"tx\":\n                validated = inrange(data.tx,4,20);\n                cause = \"Sending Power\";\n                break;\n            case \"sf\":\n                validated = inrange(data.sf,7,12);\n                cause = \"Spreading Factor\";\n                break;\n            case \"friendly\":\n                validated = true;\n                break;\n            case \"iv\":\n                minInterval = (isNaN(minInterval)) ? 4000 : minInterval;\n                validated = inrange(data.iv,minInterval,Infinity);\n                cause = `Send Interval is at least ${minInterval} ms !`;\n                break;\n        }\n        if(!validated) break;\n    }else{\n        validated = true;\n        continue;\n    }\n}\n\nmsg.topic = validated;\nmsg.cause = cause;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 960,
        "wires": [
            [
                "7b8ee05a.b7734",
                "e2a7d40.bca1a3",
                "53654a49.b88fe4"
            ]
        ]
    },
    {
        "id": "3713a25e.4245de",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "topic": "",
        "name": "Not Valid",
        "x": 1160,
        "y": 1040,
        "wires": [
            []
        ]
    },
    {
        "id": "e2a7d40.bca1a3",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Show Notification",
        "func": "if(msg.payload.nodes === undefined){\n    msg.payload = \"No Device Selected\";\n    msg.topic = \"Configuration not valid!\";\n    return msg;\n}\n\nif(msg.topic){\n    msg.payload = \"Valid Configuration. Executed\";\n    msg.topic = \"Done.\";\n}else{\n    msg.payload = \"Choose other Params for \"+msg.cause;\n    msg.topic = \"Configuration not valid!\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 830,
        "y": 1020,
        "wires": [
            [
                "b348ca1d.2665f8"
            ]
        ]
    },
    {
        "id": "c72739fc.76ccc8",
        "type": "ui_dropdown",
        "z": "922120e5.5b086",
        "name": "Choose Gateway",
        "label": "",
        "tooltip": "",
        "place": "Select Gateway to be configured",
        "group": "41b7f885.973478",
        "order": 2,
        "width": 11,
        "height": 1,
        "passthru": false,
        "multiple": true,
        "options": [],
        "payload": "",
        "topic": "nodes",
        "topicType": "str",
        "x": 550,
        "y": 1280,
        "wires": [
            [
                "eb1f6d8d.7bd5",
                "468f1d28.df4054"
            ]
        ]
    },
    {
        "id": "f2230676.6a28f8",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Load Devices",
        "func": "nodes = global.get(\"LORIDANE.devices.gw\");\noptions = [];\n\nfor (var node in nodes){\n    let name = \"\";\n    if(nodes[node].friendlyname != \"\" && nodes[node].friendlyname != undefined){\n        name = `${nodes[node].uid} - ${nodes[node].friendlyname}`;\n        options[node] = {[name]:nodes[node].uid};\n    }else{\n        name = `${nodes[node].uid}`;\n        options[node] = {[name]:nodes[node].uid} ;\n    }\n}\nreturn {options:options};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 1280,
        "wires": [
            [
                "c72739fc.76ccc8"
            ]
        ]
    },
    {
        "id": "56eb94c8.88784c",
        "type": "debug",
        "z": "922120e5.5b086",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1050,
        "y": 1280,
        "wires": []
    },
    {
        "id": "7b4795bf.a3635c",
        "type": "inject",
        "z": "922120e5.5b086",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 190,
        "y": 1240,
        "wires": [
            [
                "f2230676.6a28f8"
            ]
        ]
    },
    {
        "id": "eb1f6d8d.7bd5",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Join Configurations",
        "func": "nodes = msg.payload;\nif(msg.topic == \"nodes\"){\n    context.set(\"nodes\",nodes);\n    return;\n}\n\nif(msg.topic == \"data\"){\n    nodes = context.get(\"nodes\");\n    data = msg.payload;\n    data.freq /= 10;\n    data.sf /= 1; \n    data.tx /= 1;\n}\nmsg.payload = {nodes:nodes,data:data};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 1320,
        "wires": [
            [
                "59a2d840.f900a8"
            ]
        ]
    },
    {
        "id": "f98093c4.e9116",
        "type": "ui_form",
        "z": "922120e5.5b086",
        "name": "",
        "label": "Configure chosen Gateway(s)",
        "group": "41b7f885.973478",
        "order": 6,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "Friendly Name (eg. Milling Center 1)",
                "value": "friendly",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Frequency (8672 for 867.2MHz)",
                "value": "freq",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Spreading Factor (7-12)",
                "value": "sf",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Sending Power (4 - 20)",
                "value": "tx",
                "type": "text",
                "required": false,
                "rows": null
            }
        ],
        "formValue": {
            "friendly": "",
            "freq": "",
            "sf": "",
            "tx": ""
        },
        "payload": "",
        "submit": "Submit",
        "cancel": "Cancel",
        "topic": "data",
        "topicType": "str",
        "splitLayout": "",
        "className": "",
        "x": 450,
        "y": 1360,
        "wires": [
            [
                "eb1f6d8d.7bd5"
            ]
        ]
    },
    {
        "id": "59a2d840.f900a8",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Validate Data",
        "func": "data = msg.payload.data;\nlet topic = true;\ninrange = global.get(\"LORIDANE.funcs.inRangeOf\");\n\nconst timeOnAir = global.get(\"LORIDANE.values.lastPayloadLens.toa\");\nlet minInterval = global.get(\"LORIDANE.values.lastPayloadLens.minInterval\") || 5000;\nconst allowed = global.get(\"LORIDANE.funcs.allowed\");\nif(data.freq === 0){\n    data.freq = global.get(\"LORIDANE.devices.gw[0].freq\") / (1e6);\n}\n\nvalidated = false;\nkeys = Object.keys(data);\ncause = \"\";\n\nfor(var key of keys){\n    validated = false;\n    if(data[key]){\n        switch(key){\n            case \"freq\":\n                fromAllowed = allowed(data.freq);\n                validated = fromAllowed.allowed;\n                cause = \"Forbidden Frequency \"+data.freq+\"MHz, try \"+fromAllowed.instead+\" MHz instead\";\n                break;\n            case \"tx\":\n                validated = inrange(data.tx,4,20);\n                cause = \"Sending Power\";\n                break;\n            case \"sf\":\n                validated = inrange(data.sf,7,12);\n                cause = \"Spreading Factor\";\n                break;\n            case \"friendly\":\n                validated = true;\n                break;\n        }\n        if(!validated) break;\n    }else{\n        validated = true;\n        continue;\n    }\n}\n\nmsg.topic = validated;\nmsg.cause = cause;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 1320,
        "wires": [
            [
                "3a7408c4.bf13f8",
                "1733b022.f7d1a"
            ]
        ]
    },
    {
        "id": "22a3945.0e1b46c",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "topic": "",
        "name": "Not Valid",
        "x": 1160,
        "y": 1480,
        "wires": [
            []
        ]
    },
    {
        "id": "3a7408c4.bf13f8",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Show Notification",
        "func": "if(msg.payload.nodes === undefined){\n    msg.payload = \"No Device Selected\";\n    msg.topic = \"Configuration not valid!\";\n    return msg;\n}\n\nif(msg.topic){\n    msg.payload = \"Valid Configuration. Executed\";\n    msg.topic = \"Done.\";\n}else{\n    msg.payload = \"Choose other Params for \"+msg.cause;\n    msg.topic = \"Configuration not valid!\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 1380,
        "wires": [
            [
                "b5a00295.9f04a"
            ]
        ]
    },
    {
        "id": "c95a63e2.3f422",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Load Devices",
        "func": "nodes = global.get(\"LORIDANE.devices.nodes\");\ngateways = global.get(\"LORIDANE.devices.gw\");\n\noptions = [];\n\nfor (var node in nodes){\n    options.push(nodes[node].uid);\n}\nfor (var gw in gateways){\n    options.push(gateways[gw].uid);\n}\ntopic = \"nodes\";\nreturn {topic: topic, options:options};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 1640,
        "wires": [
            [
                "6146c722.a38c28"
            ]
        ]
    },
    {
        "id": "391eb595.282f6a",
        "type": "debug",
        "z": "922120e5.5b086",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1310,
        "y": 1600,
        "wires": []
    },
    {
        "id": "6146c722.a38c28",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Join Configurations",
        "func": "nodes = msg.options;\nlet data;\n\nif(msg.topic == \"nodes\"){\n    context.set(\"nodes\",nodes);\n    return;\n}\n\nif(msg.topic == \"data\"){\n    nodes = context.get(\"nodes\");\n    data = msg.payload;\n    data.freq /= 10;\n    data.sf /= 1; \n    data.tx /= 1;\n    data.iv *= 1000;\n}\n\nmsg.payload = {nodes:nodes,data:data};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 1660,
        "wires": [
            [
                "215e0ff.224dbf"
            ]
        ]
    },
    {
        "id": "1c412889.16aae7",
        "type": "ui_form",
        "z": "922120e5.5b086",
        "name": "",
        "label": "Configure Devices",
        "group": "5db15994.d9fc08",
        "order": 4,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "Frequency (8672 for 867.2MHz)",
                "value": "freq",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Spreading Factor (7-12)",
                "value": "sf",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Sending Power (4 - 20)",
                "value": "tx",
                "type": "text",
                "required": false,
                "rows": null
            },
            {
                "label": "Sending Interval (seconds)",
                "value": "iv",
                "type": "text",
                "required": false,
                "rows": null
            }
        ],
        "formValue": {
            "freq": "",
            "sf": "",
            "tx": "",
            "iv": ""
        },
        "payload": "",
        "submit": "Submit",
        "cancel": "Cancel",
        "topic": "data",
        "topicType": "str",
        "splitLayout": "",
        "className": "",
        "x": 210,
        "y": 1660,
        "wires": [
            [
                "c95a63e2.3f422",
                "1b40754c.f5998b"
            ]
        ]
    },
    {
        "id": "215e0ff.224dbf",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Validate Data",
        "func": "data = msg.payload.data;\nlet topic = true;\nlet minInterval = global.get(\"LORIDANE.values.lastPayloadLens.minInterval\") || 5000;\n\ninrange = global.get(\"LORIDANE.funcs.inRangeOf\");\nconst timeOnAir = global.get(\"LORIDANE.values.lastPayloadLens.toa\");\n//node.warn(msg) //debug\nconst allowed = global.get(\"LORIDANE.funcs.allowed\");\n\nvalidated = false;\nkeys = Object.keys(data);\ncause = \"\";\n\nfor(var key of keys){\n    validated = false;\n    if(data[key]){\n        switch(key){\n            case \"freq\":\n                fromAllowed = allowed(data.freq);\n                validated = fromAllowed.allowed;\n                cause = \"Forbidden Frequency \"+data.freq+\"MHz, try \"+fromAllowed.instead+\" MHz instead\";\n                break;\n            case \"tx\":\n                validated = inrange(data.tx,4,20);\n                cause = \"Sending Power\";\n                break;\n            case \"sf\":\n                validated = inrange(data.sf,7,12);\n                cause = \"Spreading Factor\";\n                break;\n            case \"friendly\":\n                validated = true;\n                break;\n            case \"iv\":\n                minInterval = (isNaN(minInterval)) ? 4000 : minInterval;\n                validated = inrange(data.iv,minInterval,Infinity);\n                cause = `Send Interval which is at least ${minInterval} ms!`;\n                break;\n        }\n        if(!validated) break;\n    }else{\n        validated = true;\n        continue;\n    }\n}\n\nmsg.topic = validated;\nmsg.cause = cause;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 1680,
        "wires": [
            [
                "ff5a7863.d84e28",
                "13ae9bb0.19ccf4"
            ]
        ]
    },
    {
        "id": "cca42ba6.1535c8",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "topic": "",
        "name": "Not Valid",
        "x": 1160,
        "y": 1780,
        "wires": [
            []
        ]
    },
    {
        "id": "ff5a7863.d84e28",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Show Notification",
        "func": "if(msg.topic){\n    msg.payload = \"Valid Configuration. Executed\";\n    msg.topic = \"Done.\";\n}else{\n    msg.payload = \"Choose other Params for \"+msg.cause;\n    msg.topic = \"Configuration not valid!\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 1740,
        "wires": [
            [
                "f78e6e10.09523"
            ]
        ]
    },
    {
        "id": "13ae9bb0.19ccf4",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Send configuration to nodes",
        "func": "if(!msg.topic){\n    return;\n}\ndata = msg.payload.data;\nnstream = \"cn:\";\n\ngateways = [];\nnodes = msg.payload.nodes;\nfor(i=nodes.length-1;i>=0;i--){\n    if(nodes[i].startsWith(\"GW\")){\n        gateways.push(nodes[i]);\n    }else{\n        break;\n    }\n}\n\nkeys = Object.keys(data);\nfor(var key of keys){\n    if(data[key] === 0){\n        continue;\n    }\n    switch(key){\n        case \"freq\":\n            freq = data.freq;\n            freq*=10;\n            nstream += \"fn:\"+freq+\";\";\n            break;\n        case \"tx\":\n            nstream += \"tn:\"+data.tx+\";\";\n            break;\n        case \"iv\":\n            nstream += \"iv:\"+data.iv+\";\";\n            break;\n        case \"sf\":\n            nstream += \"sn:\"+data.sf+\";\";\n    }\n}\nif (nstream == 'cn')return;\nlet gstream = nstream.replace(\"cn\",\"cg\").replace(\"fn\",\"fg\").replace(\"sn\",\"sg\");\n\nfor (var gw of gateways){\n    topic = \"lora/\"+gw;\n    node.send({payload:nstream,topic:topic});\n    node.send({payload:gstream,topic:topic});\n}\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 1680,
        "wires": [
            [
                "60d33b08.42a134",
                "9e3d1b59.23c838",
                "391eb595.282f6a",
                "db7480dc.a712b"
            ]
        ],
        "info": "[44,253,37,253,253,23,66,253,253,82,38,253,253,92,253,25,253,47,56,253,101,253,253,53,4,110,21,253,99,90]\n\nif(!msg.topic){\n    return;\n}\ndata = msg.payload.data;\nstream = \"cg:cn:\";\n\ngateways = [];\nnodes = msg.payload.nodes;\nfor(i=nodes.length-1;i>=0;i--){\n    if(nodes[i].startsWith(\"GW\")){\n        gateways.push(nodes[i]);\n    }else{\n        break;\n    }\n}\n\nkeys = Object.keys(data);\nfor(var key of keys){\n    if(data[key] === 0){\n        continue;\n    }\n    switch(key){\n        case \"freq\":\n            freq = data.freq;\n            freq*=10;\n            stream += \"fn:\"+freq+\";fg:\"+freq+\";\";\n            break;\n        case \"tx\":\n            stream += \"tn:\"+data.tx+\";\";\n            break;\n        case \"iv\":\n            stream += \"iv:\"+data.iv+\";\";\n            break;\n        case \"sf\":\n            stream += \"sn:\"+data.sf+\";sg:\"+data.sf+\";\";\n    }\n}\n\nfor (var gw of gateways){\n    topic = \"lora/\"+gw;\n    node.send({payload:stream,topic:topic});\n}\n\nreturn;"
    },
    {
        "id": "4ec1c59.3c72e3c",
        "type": "ui_text",
        "z": "922120e5.5b086",
        "group": "5db15994.d9fc08",
        "order": 3,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Note:",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "x": 390,
        "y": 1600,
        "wires": []
    },
    {
        "id": "3e988854.756f78",
        "type": "inject",
        "z": "922120e5.5b086",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "If you don't wish to change a particular value, leave empty.",
        "payloadType": "str",
        "x": 250,
        "y": 1600,
        "wires": [
            [
                "4ec1c59.3c72e3c",
                "60d33b08.42a134"
            ]
        ]
    },
    {
        "id": "2298bc32.b5d154",
        "type": "ui_text",
        "z": "922120e5.5b086",
        "group": "41b7f885.973478",
        "order": 3,
        "width": 12,
        "height": 2,
        "name": "",
        "label": "Note:",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "x": 550,
        "y": 1240,
        "wires": []
    },
    {
        "id": "352c4653.23cc2a",
        "type": "inject",
        "z": "922120e5.5b086",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "If you don't wish to change a particular value, leave empty. Please make sure you configure the Nodes first, otherwise they will loose connection!",
        "payloadType": "str",
        "x": 410,
        "y": 1240,
        "wires": [
            [
                "2298bc32.b5d154"
            ]
        ]
    },
    {
        "id": "a503dd65.c955c",
        "type": "ui_text",
        "z": "922120e5.5b086",
        "group": "a3b84e04.bcada",
        "order": 3,
        "width": 12,
        "height": 2,
        "name": "",
        "label": "Note:",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "x": 510,
        "y": 860,
        "wires": []
    },
    {
        "id": "85e5fa2c.0e6c48",
        "type": "inject",
        "z": "922120e5.5b086",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "If you don't wish to change a particular value, leave empty. Please make sure you configure a Node to parameters you will have a Gateway running on!",
        "payloadType": "str",
        "x": 370,
        "y": 860,
        "wires": [
            [
                "a503dd65.c955c"
            ]
        ]
    },
    {
        "id": "66e70a8c.9b9414",
        "type": "ui_text",
        "z": "922120e5.5b086",
        "group": "5db15994.d9fc08",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Current Settings",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "x": 780,
        "y": 1780,
        "wires": []
    },
    {
        "id": "60d33b08.42a134",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "show current settings",
        "func": "settings = global.get(\"LORIDANE.devices.gw[0]\");\nfreq = settings.freq / 1e6;\nsf = settings.sf;\nmsg.payload = \"Frequency: \"+freq+\" MHz , SF: \"+sf;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 1780,
        "wires": [
            [
                "66e70a8c.9b9414"
            ]
        ]
    },
    {
        "id": "1733b022.f7d1a",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Send configuration to nodes",
        "func": "if(!msg.topic){\n    return;\n}\ndata = msg.payload.data;\nstream = \"cg:\";\n\ngateways = [];\nnodes = msg.payload.nodes;\nfor(i=nodes.length-1;i>=0;i--){\n    if(nodes[i].startsWith(\"GW\")){\n        gateways.push(nodes[i]);\n    }else{\n        break;\n    }\n}\n\nkeys = Object.keys(data);\nfor(var key of keys){\n    if(data[key] === 0){\n        continue;\n    }\n    switch(key){\n        case \"freq\":\n            freq = data.freq;\n            freq*=10;\n            stream += \"fg:\"+freq+\";\";\n            break;\n        case \"tx\":\n            stream += \"tg:\"+data.tx+\";\";\n            break;\n        case \"sf\":\n            stream += \"sg:\"+data.sf+\";\";\n    }\n}\n\nfor (var gw of gateways){\n    topic = \"lora/\"+gw;\n    if (stream != \"cg:\"){\n    node.send({payload:stream,topic:topic});\n    }\n}\n\nif (data.friendly != \"\"){\n    node.send({friendlyname:{name:data.friendly,uid:nodes[0]}});\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1180,
        "y": 1320,
        "wires": [
            [
                "9e3d1b59.23c838",
                "db7480dc.a712b"
            ]
        ]
    },
    {
        "id": "53654a49.b88fe4",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Send configuration to nodes",
        "func": "if(!msg.topic){\n    return;\n}\ndata = msg.payload.data;\nstream = \"\";\n\ngateways = [];\nnodes = msg.payload.nodes;\nnodesHDD = global.get(\"LORIDANE.devices.nodes\");\n\nfor(i=0;i <= nodes.length-1;i++){\n    for(j=0;i <= nodesHDD.length-1;j++)\n    if(nodes[i]==nodesHDD[j].uid){\n        gateways.push(nodesHDD[j].nextGW);\n        break;\n    }\n}\n\nkeys = Object.keys(data);\nfor(var key of keys){\n    if(data[key] === 0){\n        continue;\n    }\n    switch(key){\n        case \"freq\":\n            freq = data.freq;\n            freq*=10;\n            stream += \"fn:\"+freq+\";\";\n            break;\n        case \"tx\":\n            stream += \"tn:\"+data.tx+\";\";\n            break;\n        case \"sf\":\n            stream += \"sn:\"+data.sf+\";\";\n            break;\n        case \"iv\":\n            stream += \"iv:\"+data.iv+\";\"\n    }\n}\n\nfor (var gw of gateways){\n    topic = \"lora/\"+gw;\n    \n    for(var nd in nodes){\n        if(stream != \"cn:\"){\n        node.send({payload:nodes[nd]+stream,topic:topic});\n        }\n    }\n    \n}\n\nif (data.friendly != \"\"){\n    node.send({friendlyname:{name:data.friendly,uid:nodes[0]}});\n}\n\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 960,
        "wires": [
            [
                "9e3d1b59.23c838",
                "db7480dc.a712b"
            ]
        ]
    },
    {
        "id": "45f7dc03.fc10c4",
        "type": "subflow:2fad0fdc.1d24b",
        "z": "922120e5.5b086",
        "name": "",
        "x": 1520,
        "y": 860,
        "wires": []
    },
    {
        "id": "9e3d1b59.23c838",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "neglect msg friendlyname",
        "func": "if(msg.friendlyname !== undefined){\n    return;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1510,
        "y": 820,
        "wires": [
            [
                "45f7dc03.fc10c4",
                "2581615a.b8042e"
            ]
        ]
    },
    {
        "id": "ab4e4547.8c5b08",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "reload gateways",
        "group": "41b7f885.973478",
        "order": 1,
        "width": 1,
        "height": 1,
        "passthru": false,
        "label": "",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "sync",
        "payload": "",
        "payloadType": "date",
        "topic": "topic",
        "topicType": "msg",
        "x": 260,
        "y": 1180,
        "wires": [
            [
                "f2230676.6a28f8"
            ]
        ]
    },
    {
        "id": "54c024d3.7922fc",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "reload nodes",
        "group": "a3b84e04.bcada",
        "order": 1,
        "width": 1,
        "height": 1,
        "passthru": false,
        "label": "",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "sync",
        "payload": "",
        "payloadType": "date",
        "topic": "topic",
        "topicType": "msg",
        "x": 224,
        "y": 813,
        "wires": [
            [
                "fa0f21a7.2fba9"
            ]
        ]
    },
    {
        "id": "f78e6e10.09523",
        "type": "switch",
        "z": "922120e5.5b086",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Done.",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Configuration not valid!",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1010,
        "y": 1740,
        "wires": [
            [
                "8844158.8c2fce8"
            ],
            [
                "cca42ba6.1535c8"
            ]
        ]
    },
    {
        "id": "8844158.8c2fce8",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "top right",
        "displayTime": "5",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "topic": "",
        "name": "Valid",
        "x": 1170,
        "y": 1740,
        "wires": []
    },
    {
        "id": "b5a00295.9f04a",
        "type": "switch",
        "z": "922120e5.5b086",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Done.",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Configuration not valid!",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1030,
        "y": 1380,
        "wires": [
            [
                "f2b963e8.b0971"
            ],
            [
                "22a3945.0e1b46c"
            ]
        ]
    },
    {
        "id": "b348ca1d.2665f8",
        "type": "switch",
        "z": "922120e5.5b086",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Done.",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Configuration not valid!",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 990,
        "y": 1020,
        "wires": [
            [
                "49071612.a43728"
            ],
            [
                "3713a25e.4245de"
            ]
        ]
    },
    {
        "id": "f2b963e8.b0971",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "top right",
        "displayTime": "5",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "topic": "",
        "name": "Valid",
        "x": 1170,
        "y": 1360,
        "wires": []
    },
    {
        "id": "49071612.a43728",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "top right",
        "displayTime": "5",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "topic": "",
        "name": "Valid",
        "x": 1150,
        "y": 1000,
        "wires": []
    },
    {
        "id": "468f1d28.df4054",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "show current settings",
        "func": "gws = msg.payload;\nsettings = global.get(\"LORIDANE.devices.gw\");\nlet freq;\nlet friendly;\nlet sf;\nlet arr = [];\n\n\nfor (var gw in gws){\n    for(var s in settings){\n        if(gws[gw] == settings[s].uid){\n            (settings[s].friendlyname === undefined || settings[s].friendlyname == \"\") ? friendly = settings[s].uid : friendly = settings[s].friendlyname;\n            freq = settings[s].freq / 1e6;\n            sf = settings[s].sf;\n            arr.push(\"GW: \"+friendly+\" , Frequency: \"+freq+\" MHz , SF: \"+sf);\n        }\n    }\n}\n\nfreq = settings.freq / 1e6;\nsf = settings.sf;\nmsg.payload = arr.join(\"; \");\n\nif(msg.payload.length > 0){\n    msg.title = \"Current Settings\";\n}else{\n    msg.title = \"\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 1420,
        "wires": [
            [
                "81db2db4.c0215"
            ]
        ]
    },
    {
        "id": "81db2db4.c0215",
        "type": "ui_text",
        "z": "922120e5.5b086",
        "group": "41b7f885.973478",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "Current GW Settings",
        "label": "{{msg.title}}",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "x": 620,
        "y": 1420,
        "wires": []
    },
    {
        "id": "ee9ebb95.cbbc28",
        "type": "ui_text",
        "z": "922120e5.5b086",
        "group": "5db15994.d9fc08",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "Current Global Settings",
        "label": "{{msg.topic}}",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "x": 1530,
        "y": 720,
        "wires": []
    },
    {
        "id": "2581615a.b8042e",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "send with delay",
        "func": "setTimeout(()=>node.send({topic:\"\",payload:\"\"}),15000);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1520,
        "y": 760,
        "wires": [
            [
                "ee9ebb95.cbbc28",
                "fdb2ae6d.5c6f9",
                "59421bc.49712e4"
            ]
        ]
    },
    {
        "id": "fdb2ae6d.5c6f9",
        "type": "ui_text",
        "z": "922120e5.5b086",
        "group": "a3b84e04.bcada",
        "order": 5,
        "width": 0,
        "height": 0,
        "name": "Current Node Settings",
        "label": "{{msg.topic}}",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "x": 1520,
        "y": 680,
        "wires": []
    },
    {
        "id": "59421bc.49712e4",
        "type": "ui_text",
        "z": "922120e5.5b086",
        "group": "41b7f885.973478",
        "order": 5,
        "width": 0,
        "height": 0,
        "name": "Current GW Settings",
        "label": "{{msg.topic}}",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "x": 1520,
        "y": 640,
        "wires": []
    },
    {
        "id": "1fbeb059.389d9",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "show current settings",
        "func": "gws = msg.payload;\nsettings = global.get(\"LORIDANE.devices.nodes\");\nlet freq;\nlet friendly;\nlet sf;\nlet arr = [];\n\n\nfor (var gw in gws){\n    for(var s in settings){\n        if(gws[gw] == settings[s].uid){\n            (settings[s].friendlyname === undefined || settings[s].friendlyname == \"\") ? friendly = settings[s].uid : friendly = settings[s].friendlyname;\n            freq = settings[s].freq / 1e6;\n            sf = settings[s].sf;\n            arr.push(\"Node: \"+friendly+\" , Frequency: \"+freq+\" MHz , SF: \"+sf);\n        }\n    }\n}\n\nfreq = settings.freq / 1e6;\nsf = settings.sf;\nmsg.payload = arr.join(\"; \");\n\nif(msg.payload.length > 0){\n    msg.title = \"Current Settings\";\n}else{\n    msg.title = \"\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 800,
        "wires": [
            [
                "4f0740b.eec94c"
            ]
        ]
    },
    {
        "id": "4f0740b.eec94c",
        "type": "ui_text",
        "z": "922120e5.5b086",
        "group": "a3b84e04.bcada",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "Current Node Settings",
        "label": "{{msg.title}}",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "x": 560,
        "y": 1020,
        "wires": []
    },
    {
        "id": "e07d7f1f.6ba2e",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Load Devices",
        "func": "let nodes = global.get(\"LORIDANE.devices.nodes\");\nlet gws = global.get(\"LORIDANE.devices.gw\");\nlet options = [];\n\n// as list for the choose device dropdown load the device an if available the friendlyname\nfor (var node in nodes){\n    let name = \"\";\n    if(nodes[node].friendlyname != \"\" && nodes[node].friendlyname != undefined){\n        name = `${nodes[node].uid} - ${nodes[node].friendlyname}`;\n        options[node] = {[name]:nodes[node].uid};\n    }else{\n        name = `${nodes[node].uid}`;\n        options[node] = {[name]:nodes[node].uid} ;\n    }\n}\nfor (var gw in gws){\n    let name = \"\";\n    if(gws[gw].friendlyname != \"\" && gws[gw].friendlyname != undefined){\n        name = `${gws[gw].uid} - ${gws[gw].friendlyname}`;\n        options.push({[name]:gws[gw].uid});\n    }else{\n        name = `${gws[gw].uid}`;\n        options.push({[name]:gws[gw].uid}) ;\n    }\n}\n\nreturn {options:options};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 480,
        "wires": [
            [
                "50226140.c74eb"
            ]
        ]
    },
    {
        "id": "50226140.c74eb",
        "type": "ui_dropdown",
        "z": "922120e5.5b086",
        "name": "Choose Node",
        "label": "",
        "tooltip": "",
        "place": "Select Device to be deleted",
        "group": "753624ea.23803c",
        "order": 2,
        "width": 7,
        "height": 1,
        "passthru": false,
        "multiple": true,
        "options": [],
        "payload": "",
        "topic": "nodes",
        "topicType": "str",
        "x": 620,
        "y": 480,
        "wires": [
            [
                "b0281ebc.4de1c"
            ]
        ]
    },
    {
        "id": "5471fbc9.090954",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "reload nodes",
        "group": "753624ea.23803c",
        "order": 1,
        "width": 1,
        "height": 1,
        "passthru": false,
        "label": "",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "sync",
        "payload": "",
        "payloadType": "date",
        "topic": "topic",
        "topicType": "msg",
        "x": 270,
        "y": 480,
        "wires": [
            [
                "e07d7f1f.6ba2e"
            ]
        ]
    },
    {
        "id": "e29d8fcd.b9916",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "Cancel",
        "raw": false,
        "topic": "Are You Sure You want to delete this device including the configuration?",
        "name": "",
        "x": 830,
        "y": 520,
        "wires": [
            [
                "6bdca1f.8f1186"
            ]
        ]
    },
    {
        "id": "6bdca1f.8f1186",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "delete devices",
        "func": "if(msg.payload != \"OK\")return;\n\n//else\nconst deleteDevice = global.get(\"LORIDANE.funcs.deleteDevice\");\nconst writeConfig = global.get(\"LORIDANE.funcs.writeConfig\");\nignorelist = global.get(\"LORIDANE.ignorelist\")||[];\n\ndevices = msg.devices;\n\nfor(var device of devices){\n    deleteDevice(device);\n    if(!ignorelist.includes(device)){\n        ignorelist.push(device);\n    }\n}\nglobal.set(\"LORIDANE.ignorelist\",ignorelist);\nwriteConfig();\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 520,
        "wires": [
            [
                "66bb5fa0.f6e56"
            ]
        ]
    },
    {
        "id": "b0281ebc.4de1c",
        "type": "change",
        "z": "922120e5.5b086",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "devices",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 810,
        "y": 480,
        "wires": [
            [
                "e29d8fcd.b9916"
            ]
        ]
    },
    {
        "id": "66bb5fa0.f6e56",
        "type": "debug",
        "z": "922120e5.5b086",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1150,
        "y": 560,
        "wires": []
    },
    {
        "id": "1b40754c.f5998b",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "throttle",
        "func": "setTimeout((msg)=>node.send(msg),200,msg);\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 1680,
        "wires": [
            [
                "6146c722.a38c28"
            ]
        ]
    },
    {
        "id": "b0c2d3e.15b773",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "",
        "group": "14943851.2ea1c8",
        "order": 6,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Generate MAC",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "",
        "payload": "true",
        "payloadType": "bool",
        "topic": "topic",
        "topicType": "msg",
        "x": 260,
        "y": 1880,
        "wires": [
            [
                "f8f1978f.438928"
            ]
        ]
    },
    {
        "id": "f8f1978f.438928",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "generate and show mac",
        "func": "const funcs = global.get(\"LORIDANE.funcs\");\nconst gws = funcs.getUIDGW;\nconst nds = funcs.getUIDND;\nlet knownDevices = gws().concat(nds());\n\nfor (let i in knownDevices){\n    knownDevices[i] = knownDevices[i].substring(2);    \n}\n\n//node.warn(knownDevices);\n\nfunction generateMAC(){ //tests if generated MAC is already in use\n    const cr = global.get(\"crypto\");\n    var token = cr.randomBytes(6).toString('hex').toUpperCase();\n    if(knownDevices.indexOf(token) == -1){\n        msg.payload = token;\n        msg.topic = \"This is a new random MAC address token. Prefix 'GW' or 'NO' to generate a new Device ID.\"\n        return msg;\n    }else{\n        generateMAC();\n    }\n}\n\ngenerateMAC();\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 1880,
        "wires": [
            [
                "23f1460b.a13e2a"
            ]
        ]
    },
    {
        "id": "23f1460b.a13e2a",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": false,
        "outputs": 1,
        "ok": "OK I saved it",
        "cancel": "",
        "raw": false,
        "topic": "",
        "name": "",
        "x": 690,
        "y": 1880,
        "wires": [
            []
        ]
    },
    {
        "id": "eb3840c4.215ad",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "",
        "group": "d7396f84.84707",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Shutdown Server",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "",
        "payload": "Are You Sure You Want the Server to SHUTDOWN now?",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 330,
        "y": 260,
        "wires": [
            [
                "196ee81.fc56d18"
            ]
        ]
    },
    {
        "id": "196ee81.fc56d18",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "Cancel",
        "raw": false,
        "topic": "",
        "name": "",
        "x": 510,
        "y": 260,
        "wires": [
            [
                "42107d52.3b3c04"
            ]
        ]
    },
    {
        "id": "42107d52.3b3c04",
        "type": "switch",
        "z": "922120e5.5b086",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "OK",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "OK",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 680,
        "y": 260,
        "wires": [
            [
                "62e26b8b.b40d54",
                "5903f31a.a995ac"
            ],
            [
                "8ed0ed9b.1dee4"
            ]
        ]
    },
    {
        "id": "8ed0ed9b.1dee4",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "top right",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "Cancel",
        "raw": false,
        "topic": "",
        "name": "Cancelled",
        "x": 880,
        "y": 320,
        "wires": []
    },
    {
        "id": "bf8e70e6.dd7e6",
        "type": "exec",
        "z": "922120e5.5b086",
        "command": "sudo shutdown now",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "",
        "x": 1020,
        "y": 220,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "a85c6d32.5d752",
        "type": "inject",
        "z": "922120e5.5b086",
        "name": "Shutdown",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "5",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 220,
        "wires": [
            [
                "bf8e70e6.dd7e6"
            ]
        ]
    },
    {
        "id": "45074ec9.4b7d8",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "reload nodes",
        "group": "1152859e.ef93ba",
        "order": 1,
        "width": 1,
        "height": 1,
        "passthru": false,
        "label": "",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "sync",
        "payload": "",
        "payloadType": "date",
        "topic": "topic",
        "topicType": "msg",
        "x": 250,
        "y": 580,
        "wires": [
            [
                "22ce213d.bd49be"
            ]
        ]
    },
    {
        "id": "22ce213d.bd49be",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Load Devices",
        "func": "options = global.get(\"LORIDANE.ignorelist\") || [];\n\nreturn {options:options};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 580,
        "wires": [
            [
                "b93357be.3ae3e8"
            ]
        ]
    },
    {
        "id": "b93357be.3ae3e8",
        "type": "ui_dropdown",
        "z": "922120e5.5b086",
        "name": "Choose Node",
        "label": "",
        "tooltip": "",
        "place": "Select Device to move to the admission list",
        "group": "1152859e.ef93ba",
        "order": 2,
        "width": "7",
        "height": 1,
        "passthru": false,
        "multiple": true,
        "options": [],
        "payload": "",
        "topic": "nodes",
        "topicType": "str",
        "className": "",
        "x": 600,
        "y": 580,
        "wires": [
            [
                "592f4586.4bce5c"
            ]
        ]
    },
    {
        "id": "592f4586.4bce5c",
        "type": "change",
        "z": "922120e5.5b086",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "devices",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 810,
        "y": 580,
        "wires": [
            [
                "15ea37ec.d6c158"
            ]
        ]
    },
    {
        "id": "15ea37ec.d6c158",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "Cancel",
        "raw": false,
        "className": "",
        "topic": "Are You Sure You want to move this device to the admission list?",
        "name": "",
        "x": 830,
        "y": 620,
        "wires": [
            [
                "8a7fbb8d.eb5f48"
            ]
        ]
    },
    {
        "id": "8a7fbb8d.eb5f48",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "move device from ignore to admit",
        "func": "if(msg.payload != \"OK\" || msg.devices == [])return;\n\n//else\nconst writeConfig = global.get(\"LORIDANE.funcs.writeConfig\");\nlet admit = global.get(\"LORIDANE.admit\")\nlet devices = msg.devices;\nignorelist = global.get(\"LORIDANE.ignorelist\") ||[];\n\nfor(i = 0, len = devices.length; i < len; i++){\n    if (admit.indexOf(devices[i]) == -1){\n        admit.push(devices[i]);\n    }\n    try{\n        ignorelist.splice(ignorelist.indexOf(devices[i]),1);\n    }catch(e){\n        //pass\n    }\n}\nglobal.get(\"LORIDANE.ignorelist\",ignorelist);\nglobal.set(\"LORIDANE.admit\",admit);\n\nwriteConfig();\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1060,
        "y": 620,
        "wires": [
            [
                "1b4f6d0a.9a0d93"
            ]
        ]
    },
    {
        "id": "1b4f6d0a.9a0d93",
        "type": "debug",
        "z": "922120e5.5b086",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1150,
        "y": 700,
        "wires": []
    },
    {
        "id": "62e26b8b.b40d54",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "write config",
        "func": "writeConfig = global.get(\"LORIDANE.funcs.writeConfig\");\nwriteConfig(0 /**delay in ms*/);\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "47bcec4b.214e74",
        "type": "delay",
        "z": "922120e5.5b086",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 835,
        "y": 140,
        "wires": [
            [
                "e41ef28e.13734"
            ]
        ],
        "l": false
    },
    {
        "id": "5903f31a.a995ac",
        "type": "delay",
        "z": "922120e5.5b086",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 835,
        "y": 240,
        "wires": [
            [
                "bf8e70e6.dd7e6"
            ]
        ],
        "l": false
    },
    {
        "id": "db7480dc.a712b",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "write config",
        "func": "WC = global.get(\"LORIDANE.funcs.writeConfig\");\nWC(100)\nreturn;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1470,
        "y": 1480,
        "wires": []
    },
    {
        "id": "135e5aaf42390a7a",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "Load Devices",
        "func": "let nodes = global.get(\"LORIDANE.devices.nodes\");\nlet gws = global.get(\"LORIDANE.devices.gw\");\nlet options = [];\n\n// as list for the choose device dropdown load the device an if available the friendlyname\nfor (var node in nodes){\n    let name = \"\";\n    if(nodes[node].friendlyname != \"\" && nodes[node].friendlyname != undefined){\n        name = `${nodes[node].uid} - ${nodes[node].friendlyname}`;\n        options[node] = {[name]:nodes[node].uid};\n    }else{\n        name = `${nodes[node].uid}`;\n        options[node] = {[name]:nodes[node].uid} ;\n    }\n}\n\nreturn {options:options};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 2140,
        "wires": [
            [
                "72fde4c855eb24ff"
            ]
        ]
    },
    {
        "id": "72fde4c855eb24ff",
        "type": "ui_dropdown",
        "z": "922120e5.5b086",
        "name": "Choose Node",
        "label": "",
        "tooltip": "",
        "place": "Select Device to show last reading",
        "group": "4640ddc61a547a32",
        "order": 2,
        "width": 7,
        "height": 1,
        "passthru": false,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "nodes",
        "topicType": "str",
        "className": "",
        "x": 540,
        "y": 2140,
        "wires": [
            [
                "bb83ef6a5cd436a5"
            ]
        ]
    },
    {
        "id": "ff637a5bb7fe4c05",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "reload nodes",
        "group": "4640ddc61a547a32",
        "order": 1,
        "width": 1,
        "height": 1,
        "passthru": false,
        "label": "",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "sync",
        "payload": "",
        "payloadType": "date",
        "topic": "topic",
        "topicType": "msg",
        "x": 190,
        "y": 2140,
        "wires": [
            [
                "135e5aaf42390a7a"
            ]
        ]
    },
    {
        "id": "169c9c4cc7c474e9",
        "type": "comment",
        "z": "922120e5.5b086",
        "name": "show last readings on dashboard",
        "info": "",
        "x": 250,
        "y": 2100,
        "wires": []
    },
    {
        "id": "bb83ef6a5cd436a5",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "show data",
        "func": "device = msg.payload;\nlastreading = global.get(`LORIDANE.data.${device}.lastreading`);\nmsg.topic = `Last received Value by ${device}:`;\nmsg.payload = JSON.stringify(lastreading,null,2);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 2140,
        "wires": [
            [
                "5443800796eb539c"
            ]
        ]
    },
    {
        "id": "5443800796eb539c",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "",
        "x": 930,
        "y": 2140,
        "wires": [
            []
        ]
    },
    {
        "id": "8a33cd54dd60903a",
        "type": "comment",
        "z": "922120e5.5b086",
        "name": "Conf Nodes",
        "info": "",
        "x": 440,
        "y": 760,
        "wires": []
    },
    {
        "id": "9f4e050b99467b7a",
        "type": "comment",
        "z": "922120e5.5b086",
        "name": "Conf Gateway",
        "info": "",
        "x": 490,
        "y": 1180,
        "wires": []
    },
    {
        "id": "4de74e1b8bf6ca3d",
        "type": "comment",
        "z": "922120e5.5b086",
        "name": "Conf Global",
        "info": "",
        "x": 570,
        "y": 1580,
        "wires": []
    },
    {
        "id": "09401e9c92cd3373",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "",
        "group": "d7396f84.84707",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "restart loridane",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "Are You Sure You Want Loridane to restart?",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 1320,
        "y": 160,
        "wires": [
            [
                "3154fa6e600c0b82"
            ]
        ]
    },
    {
        "id": "3154fa6e600c0b82",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "dialog",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK",
        "cancel": "Cancel",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "",
        "x": 1510,
        "y": 160,
        "wires": [
            [
                "8774253d35564225"
            ]
        ]
    },
    {
        "id": "8774253d35564225",
        "type": "switch",
        "z": "922120e5.5b086",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "OK",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "OK",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1680,
        "y": 160,
        "wires": [
            [
                "7f5864c8ac1fc3f8",
                "9a41840a9d647987"
            ],
            [
                "315de8a6055d3a4c"
            ]
        ]
    },
    {
        "id": "315de8a6055d3a4c",
        "type": "ui_toast",
        "z": "922120e5.5b086",
        "position": "top right",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "Cancel",
        "raw": false,
        "topic": "",
        "name": "Cancelled",
        "x": 1880,
        "y": 220,
        "wires": []
    },
    {
        "id": "2408fcb4bd699283",
        "type": "exec",
        "z": "922120e5.5b086",
        "command": "node-red-restart",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 2000,
        "y": 120,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "197e647230936896",
        "type": "inject",
        "z": "922120e5.5b086",
        "name": "Shutdown",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "5",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1330,
        "y": 120,
        "wires": [
            [
                "2408fcb4bd699283"
            ]
        ]
    },
    {
        "id": "7f5864c8ac1fc3f8",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "write config",
        "func": "writeConfig = global.get(\"LORIDANE.funcs.writeConfig\");\nwriteConfig(0 /**delay in ms*/);\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2160,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "9a41840a9d647987",
        "type": "delay",
        "z": "922120e5.5b086",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1835,
        "y": 140,
        "wires": [
            [
                "2408fcb4bd699283"
            ]
        ],
        "l": false
    },
    {
        "id": "5731a85d08ea3dd5",
        "type": "function",
        "z": "922120e5.5b086",
        "name": "clear Ignore an admission list",
        "func": "list = [];\nglobal.set(\"LORIDANE.ignorelist\",list);\nglobal.set(\"LORIDANE.admit\",list);\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "12abec650d9f6642",
        "type": "ui_button",
        "z": "922120e5.5b086",
        "name": "",
        "group": "1152859e.ef93ba",
        "order": 1,
        "width": "8",
        "height": 1,
        "passthru": false,
        "label": "clear ignorelist",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "",
        "payloadType": "date",
        "topic": "topic",
        "topicType": "msg",
        "x": 260,
        "y": 640,
        "wires": [
            [
                "5731a85d08ea3dd5"
            ]
        ]
    },
    {
        "id": "1152859e.ef93ba",
        "type": "ui_group",
        "z": "922120e5.5b086",
        "name": "Ignore List",
        "tab": "1809f267.7a279e",
        "order": 3,
        "disp": true,
        "width": "8",
        "collapse": false
    },
    {
        "id": "f798079b.0c85e8",
        "type": "ui_spacer",
        "z": "922120e5.5b086",
        "name": "spacer",
        "group": "bf837bc6.2c47f8",
        "order": 3,
        "width": 1,
        "height": 1
    },
    {
        "id": "fe39cdd7.d53ea",
        "type": "ui_spacer",
        "z": "922120e5.5b086",
        "name": "spacer",
        "group": "bf837bc6.2c47f8",
        "order": 5,
        "width": 1,
        "height": 1
    },
    {
        "id": "905bed34.63eb3",
        "type": "ui_spacer",
        "z": "922120e5.5b086",
        "name": "spacer",
        "group": "bf837bc6.2c47f8",
        "order": 6,
        "width": 1,
        "height": 1
    },
    {
        "id": "b762c9b2.4a59b8",
        "type": "ui_spacer",
        "z": "922120e5.5b086",
        "name": "spacer",
        "group": "bf837bc6.2c47f8",
        "order": 7,
        "width": 1,
        "height": 1
    },
    {
        "id": "db209ff8.5830f",
        "type": "ui_spacer",
        "z": "922120e5.5b086",
        "name": "spacer",
        "group": "bf837bc6.2c47f8",
        "order": 8,
        "width": 1,
        "height": 1
    },
    {
        "id": "41a7925c.8a3c6c",
        "type": "ui_spacer",
        "z": "922120e5.5b086",
        "name": "spacer",
        "group": "bf837bc6.2c47f8",
        "order": 9,
        "width": 1,
        "height": 1
    },
    {
        "id": "a6441479.e064f8",
        "type": "ui_spacer",
        "z": "922120e5.5b086",
        "name": "spacer",
        "group": "bf837bc6.2c47f8",
        "order": 10,
        "width": 1,
        "height": 1
    },
    {
        "id": "5e652f73.af4fe",
        "type": "ui_spacer",
        "z": "922120e5.5b086",
        "name": "spacer",
        "group": "bf837bc6.2c47f8",
        "order": 11,
        "width": 1,
        "height": 1
    },
    {
        "id": "a3b84e04.bcada",
        "type": "ui_group",
        "name": "Configure Single Node",
        "tab": "7f451d99.cdaae4",
        "order": 1,
        "disp": true,
        "width": "12",
        "collapse": false
    },
    {
        "id": "41b7f885.973478",
        "type": "ui_group",
        "name": "Configure Gateway",
        "tab": "6b5685b0.8ca3ec",
        "order": 1,
        "disp": true,
        "width": "12",
        "collapse": false,
        "className": ""
    },
    {
        "id": "5db15994.d9fc08",
        "type": "ui_group",
        "name": "Change Global Network Configuration",
        "tab": "842e81e.7f33f8",
        "order": 1,
        "disp": true,
        "width": "12",
        "collapse": false,
        "className": ""
    },
    {
        "id": "753624ea.23803c",
        "type": "ui_group",
        "name": "Delete Device",
        "tab": "1809f267.7a279e",
        "order": 5,
        "disp": true,
        "width": "8",
        "collapse": false
    },
    {
        "id": "14943851.2ea1c8",
        "type": "ui_group",
        "name": "Address Generator",
        "tab": "1809f267.7a279e",
        "order": 3,
        "disp": true,
        "width": "8",
        "collapse": false
    },
    {
        "id": "bf837bc6.2c47f8",
        "type": "ui_group",
        "d": true,
        "name": "ONRO",
        "tab": "278b2300.ae23ae",
        "order": 3,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "7f451d99.cdaae4",
        "type": "ui_tab",
        "name": "Configure Node",
        "icon": "fa-microchip",
        "order": 4,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "6b5685b0.8ca3ec",
        "type": "ui_tab",
        "name": "Configure Gateway",
        "icon": "wifi",
        "order": 3,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "842e81e.7f33f8",
        "type": "ui_tab",
        "name": "Global Config",
        "icon": "fa-globe",
        "order": 2,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "1395c386.064e8c",
        "type": "subflow",
        "name": "LORIDANE - Init",
        "info": "",
        "category": "Loridane",
        "in": [],
        "out": [],
        "env": [],
        "meta": {
            "license": "GPL-3.0"
        },
        "color": "#3FADB5",
        "icon": "node-red/cog.svg",
        "status": {
            "x": 660,
            "y": 180,
            "wires": [
                {
                    "id": "dd36f402.134978",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "dd36f402.134978",
        "type": "status",
        "z": "1395c386.064e8c",
        "name": "",
        "scope": null,
        "x": 540,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "ad0a1802.1bc0f8",
        "type": "inject",
        "z": "1395c386.064e8c",
        "name": "Load Device Configs",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "topic": "",
        "payloadType": "date",
        "x": 160,
        "y": 80,
        "wires": [
            [
                "74934f3780837a8f"
            ]
        ]
    },
    {
        "id": "a0be56ff.ac9d48",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "set config path by user",
        "func": "const USER = msg.user;\nmsg.payload = `/home/${USER}/LORIDANE/config/`;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 795,
        "y": 80,
        "wires": [
            [
                "dbefc9ac.db1378"
            ]
        ],
        "l": false
    },
    {
        "id": "dbefc9ac.db1378",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "Watch Config Folder",
        "func": "function loadConfig(user, homepath){\n            //Import filesystem Lib\n            const fs = global.get(\"fs\");\n            let LORIDANE = {};\n            let memCache = {};\n            let config;\n            LORIDANE.LinuxUsername = user;\n            node.status({text:\"Reading Config File and load to Memcache\"})\n\n            //Look for the config file\n            let path = homepath+\"loridaneConfig.json\";\n\n            try{\n                config = JSON.parse(fs.readFileSync(path)); //load config\n            }catch(e){\n                node.warn(\"Error when loading config: \"+e);\n                return false;\n            }\n\n            delete config._comment;\n            LORIDANE.settings = config;\n\n            //change path to the path of the memcache file\n            path = LORIDANE.settings.path.config+\"memCacheLoridane.json\";\n\n            if(fs.existsSync(path)){\n                try{\n                    memCache = JSON.parse(fs.readFileSync(path));\n                }catch (e){\n                    node.warn(e);\n                }\n            }\n            //check if memCache exists and concat objects\n            if(memCache) LORIDANE = {...memCache,...LORIDANE};\n            LORIDANE.blockONstart = false;\n\n            // save to memcache    \n            global.set(\"LORIDANE\",LORIDANE);\n            setTimeout(()=>node.status({text:\"Initialized\"}),3000);\n            return true;\n}\n\nif (!loadConfig(msg.user, msg.payload)){\n    node.warn(`Could not load Config from ${msg.payload}`);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 80,
        "wires": [
            [
                "793fd.aa091c034",
                "a361ed6d.d5815",
                "d435f79f.f30138",
                "c293f39ddc15f47b",
                "15da05df.3dbc1a"
            ]
        ]
    },
    {
        "id": "4a6c500.ea259b",
        "type": "exec",
        "z": "1395c386.064e8c",
        "command": "cat /etc/passwd | grep home",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "",
        "x": 380,
        "y": 240,
        "wires": [
            [
                "faf4204b.7f915"
            ],
            [],
            []
        ]
    },
    {
        "id": "faf4204b.7f915",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "Extract Username",
        "func": "data = msg.payload;\n\n// grep the name of the /home directory from <cat /etc/passwd | grep home>\nstartindex = data.indexOf(\"/home/\") + 6;\nuser = data.substring(startindex,data.indexOf(\":\",startindex));\nglobal.set([\"LORIDANE.LinuxUsername\",\"LORIDANE.blockONstart\"],[user,true]);\nnode.status({text:\"Linux Username: \"+user});\nmsg.user = user;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "793fd.aa091c034",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "Classes",
        "func": "classes = {\n    newConfig:\n        class newConfig{ // class initiator for device configs\n            constructor(UID,type,freq,sf,friendlyname,interval,nextgw){\n                this.uid = UID;\n                this.type = type;\n                this.freq = freq;\n                this.sf = sf;\n                this.friendlyname = friendlyname;\n                this.interval = interval;\n                this.nextGW = nextgw;\n            }\n        },\n\n};\nglobal.set(\"LORIDANE.classes\",classes);\nreturn msg;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 80,
        "wires": []
    },
    {
        "id": "15da05df.3dbc1a",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "Functions",
        "func": "funcs = {\n    checkUID: //**validate the device ID*/\n        function checkUID(UID){ //#bool\n            if(UID.length !== 14){\n                return false;\n            }\n            \n            if(!UID.startsWith(\"NO\") && !UID.startsWith(\"GW\")){\n                return false;\n            }\n            for (index=2;index<UID.length;index++){\n                fit = new RegExp(/([A-F0-9])/).test(UID[index]);\n                if(!fit){\n                return fit;\n                }\n            }\n            return fit;\n        },\n    inRangeOf: //**check if num value is in a range*/\n        function inRangeOf(value,lower,upper){ //#bool\n            if (value >= lower && value <= upper){\n                return true;\n            }\n            return false;\n        },\n    getUIDGW: //**get all Gateway UIDs*/\n        function getUIDGW(){ //#array of strings\n            devices = global.get(\"LORIDANE.devices.gw\");\n            let arr = [];\n            for (var d in devices){\n                arr.push(devices[d].uid);\n            }\n            return arr;\n        },\n    getUIDND: //**get all Node UIDs*/\n        function getUIDND(){ //#array of strings\n            devices = global.get(\"LORIDANE.devices.nodes\");\n            let arr = [];\n            for (var d in devices){\n                arr.push(devices[d].uid);\n            }\n            return arr;\n        },\n    findGW://**find the index of a particular Gateway*/\n        function findGW(UID){ //#integer\n            const devices = global.get(\"LORIDANE.devices.gw\");\n            let i;\n            if(UID.startsWith(\"GW\")){\n                for(i in devices){\n                    if(devices[i].uid == UID)return i;\n                }\n            }\n            return -1;\n        },\n    findNode://**find the index of a particular Node*/\n        function findNode(UID){ //#integer\n            const devices = global.get(\"LORIDANE.devices.nodes\");\n            let i;\n            if(UID.startsWith(\"NO\")){\n                for(i in devices){\n                    if(devices[i].uid == UID)return i;\n                }\n            }\n            return -1;\n        },\n    deleteDevice: //**delete a particular device from memcache*/\n        function deleteDevice(UID){ //#none\n            var devices = global.get(\"LORIDANE.devices\");\n            var nodes = devices.nodes;\n            var gws = devices.gw;\n            let index;\n            index = funcs.findGW(UID);\n            if(index >= 0){\n                gws.splice(index,1);\n                global.set(\"LORIDANE.devices.gw\",gws);\n            }\n            index = funcs.findNode(UID);\n            if(index >= 0){\n                nodes.splice(index,1);\n                global.set(\"LORIDANE.devices.nodes\",nodes);\n            }\n            return;\n        },\n    loadConfig:\n        function loadConfig(user, homepath){\n            //Import filesystem Lib\n            const fs = global.get(\"fs\");\n            let LORIDANE = {};\n            let memCache = {};\n            let config;\n            LORIDANE.LinuxUsername = user;\n            node.status({text:\"Reading Config File and load to Memcache\"})\n\n            //Look for the config file\n            let path = homepath+\"loridaneConfig.json\";\n\n            try{\n                config = JSON.parse(fs.readFileSync(path)); //load config\n            }catch(e){\n                node.warn(\"Error when loading config: \"+e);\n                return false;\n            }\n\n            delete config._comment;\n            LORIDANE.settings = config;\n\n            //change path to the path of the memcache file\n            path = LORIDANE.settings.path.config+\"memCacheLoridane.json\";\n\n            if(fs.existsSync(path)){\n                try{\n                    memCache = JSON.parse(fs.readFileSync(path));\n                }catch (e){\n                    node.warn(e);\n                }\n            }\n            //check if memCache exists and concat objects\n            if(memCache) LORIDANE = {...memCache,...LORIDANE};\n            LORIDANE.blockONstart = false;\n\n            // save to memcache    \n            global.set(\"LORIDANE\",LORIDANE);\n            global.set(\"LORIDANE.funcs\",funcs);\n            setTimeout(()=>node.status({text:\"Initialized\"}),3000);\n            return true;\n            },\n    writeConfig://*write the memcache to the memcache file**/\n        function writeConfig(delaytime){ // milliseconds #bool\n        let executed = true;\n            function writeDelayed(){\n                const fs = global.get(\"fs\");\n                var loridane =  global.get(\"LORIDANE\");\n                const configpath = loridane.settings.path.config;\n                //delete loridane.homepath;\n                const loridaneString = JSON.stringify(loridane,null,2);\n                //fs.writeFileSync(configpath+\"memCacheLoridane.json\",loridaneString)\n                fs.writeFile(configpath+\"memCacheLoridane.json\",loridaneString, err => {\n                    if (err) {\n                        console.error(err)\n                        return\n                    }\n                    //file written successfully\n                    })\n                    return true;\n                }\n                if(delaytime === 0 || delaytime === undefined){\n                    executed = writeDelayed();\n                }else{\n                    setTimeout(writeDelayed,delaytime);\n                }\n            return executed;\n        },\n        getConfig: //**get the whole configuration object by uid*/\n            function getConfig(uid){ //#object\n                let devices;\n                let device;\n                indexgw = funcs.findGW(uid);\n                indexno = funcs.findNode(uid);\n                \n                if(indexgw != -1){\n                    devices = global.get(\"LORIDANE.devices.gw\")\n                    device = devices[indexgw]\n                }else if(indexno != -1){\n                    devices = global.get(\"LORIDANE.devices.nodes\")\n                    device = devices[indexno]\n                }\n                return device;\n            },\n        decrypt:\n            function decrypt(payload){ /*String*/\n            //node.warn(payload)\n                // Only decrypt when payload is ciphered\n                const cr = global.get(\"crjs\");\n                const crypt = global.get(\"LORIDANE.settings.encryption\");\n                const key = cr.enc.Utf8.parse(crypt.key);\n                payload = payload.toString(); //force string\n                let value = cr.enc.Base64.parse(payload);\n                let buf = cr.enc.Base64.stringify(value);\n                let bytes  = cr.AES.decrypt(buf, key, {\n                    mode: cr.mode.ECB,\n                    padding: cr.pad.NoPadding,\n                    salt:\"\"\n                });\n                \n                let decrypted = bytes.toString();\n                decrypted = funcs.hex2a(decrypted);\n                //node.warn(decrypted)\n                return decrypted.substring(0, decrypted.length -2);\n            },\n            hex2a:\n            function hex2a(hexx) {\n                    var hex = hexx.toString(); // if not already is str\n                    var str = '';\n                    for (var i = 0; i < hex.length; i += 2){\n                        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));\n                    }\n                    return str;\n                    },\n            buf2hex:\n            function buf2hex(buffer) { // buffer is an ArrayBuffer\n                    return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');\n            },\n        timeOnAir:\n            function timeOnAir(bytes,sf){\n                let toa = Math.ceil((8 + ((bytes*8 - 4 * sf + 28) / (4 * sf) * 5)) * (2 ** sf) / (1e2));\n                return toa;\n            },\n        allowed:\n            function allowed(freq){\n                const allowedfreq = global.get(\"LORIDANE.values.allowedFreq\");\n                const inrange = funcs.inRangeOf;\n                for (i = 0, len = allowedfreq.length; i < len;i++){\n                    if (inrange(freq,allowedfreq[i].min,allowedfreq[i].max)){\n                        return {allowed:true, factor:allowedfreq[i].factor};\n                    }\n                    if (inrange(freq, allowedfreq[i].max, allowedfreq[i+1].min)){\n                    return {allowed:false, instead: allowedfreq[i+1].min, factor:Infinity};\n                    }\n                }\n                return {allowed:false, instead:867.0, factor: Infinity};\n            },\n        minInterval:\n            function minInterval(){\n                const toa = global.get(\"LORIDANE.values.lastPayloadLens.toa\")||51;\n                const allowed = funcs.allowed;                \n                const freq = global.get(\"LORIDANE.devices.gw[0].freq\")||867e6;\n                let IV = toa * allowed(freq / 1e6).factor||4000;\n                return IV;\n            },\n            math:{//**matematical functions*/\n                getMean://**mean of an array*/\n                    function getMean(arr){ //#double\n                        mean = arr.reduce((a,b) => a+b)/arr.length;\n                        return mean;\n                    },\n                getSmooth://**running mean of an array by smooting interval*/\n                    function getSmooth(arr,interval){ //#array\n                        smoothened = [];\n                        getMean = funcs.math.getMean;\n                        const arrcpy = arr;\n                        intHalf = Math.floor(interval/2);\n                        for(i=0;i<intHalf;i++){\n                            smoothened.push(arr[i]);\n                        }\n                        for(i = intHalf; i < arr.length - intHalf; i++){\n                            smoothened.push(getMean(arrcpy.slice(i-intHalf,i+interval)));\n                        }\n                        for(i=arr.length - intHalf;i<arr.length;i++){\n                            smoothened.push(arr[i]);\n                        }\n                        return smoothened;\n                    },\n                getCDS://**array with the numeric first or second derivative*/\n                    function getCDS(arr,order){ // # array\n                        let CDS = [0];\n                        const len = arr.length;\n                        switch(order){\n                            case 1:\n                                for(i=1;i<len-1;i++){\n                                    CDS.push((arr[i+1]-arr[i-1])/2);\n                                }\n                                break;\n                            case 2:\n                                for(i=1;i<len-1;i++){\n                                    CDS.push((arr[i+1] -2*arr[i]+arr[i-1]));\n                                }\n                                break;\n                        }\n                        CDS.push(0);\n                        return CDS;\n                    }\n                }\n};\nglobal.set(\"LORIDANE.funcs\",funcs);\nreturn;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 140,
        "wires": [],
        "info": "function hex2a(hexx) {\n                    var hex = hexx.toString();//force conversion\n                    var str = '';\n                    for (var i = 0; i < hex.length; i += 2){\n                        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));\n                    }\n                    return str;\n                    }"
    },
    {
        "id": "a361ed6d.d5815",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "Values",
        "func": "values = {\n    allowedFreq:\n        [\n            {min:863,max:864.875,factor:1000},\n            {min:865,max:868.475,factor:100},\n            {min:868.7,max:869.025,factor:1000},\n            {min:869.4,max:869.525,factor:1000},\n            {min:869.7,max:869.875,factor:100}\n        ],\n        freq:{\n            min:863,\n            max:869.875\n        }\n};\n\n\nglobal.set(\"LORIDANE.values\",values);\nreturn msg;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1150,
        "y": 200,
        "wires": []
    },
    {
        "id": "d435f79f.f30138",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "set blockonstart false",
        "func": "setTimeout(()=>global.set(\"LORIDANE.blockONstart\",false),5000)\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1150,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "74934f3780837a8f",
        "type": "exec",
        "z": "1395c386.064e8c",
        "command": "pwd",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 410,
        "y": 80,
        "wires": [
            [
                "c868a2a20ad0f13a"
            ],
            [],
            []
        ]
    },
    {
        "id": "c868a2a20ad0f13a",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "Extract Username",
        "func": "data = msg.payload;\n\ndata = data.split('/');\nlet user = data[data.length-1].replace('\\n','');\nglobal.set([\"LORIDANE.LinuxUsername\",\"LORIDANE.blockONstart\"],[user,true]);\nnode.status({text:\"Linux Username: \"+user});\nmsg.user = user;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 80,
        "wires": [
            [
                "a0be56ff.ac9d48"
            ]
        ]
    },
    {
        "id": "debfef189baa4009",
        "type": "inject",
        "z": "1395c386.064e8c",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "15",
        "topic": "",
        "payloadType": "date",
        "x": 250,
        "y": 400,
        "wires": [
            [
                "e179ea2166d2107f"
            ]
        ]
    },
    {
        "id": "2c702d141039671f",
        "type": "exec",
        "z": "1395c386.064e8c",
        "command": "sudo systemctl start mosquitto",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 990,
        "y": 400,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "e179ea2166d2107f",
        "type": "exec",
        "z": "1395c386.064e8c",
        "command": "pidof mosquitto",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 440,
        "y": 400,
        "wires": [
            [
                "58b96b7be58245f6",
                "83738104877ee419"
            ],
            [],
            []
        ]
    },
    {
        "id": "58b96b7be58245f6",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "return if payload undefined",
        "func": "//check if mqtt broker runs and if not start it\nif(!msg.payload){\n    return msg;\n}\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 380,
        "wires": [
            [
                "83738104877ee419",
                "2c702d141039671f"
            ]
        ]
    },
    {
        "id": "83738104877ee419",
        "type": "debug",
        "z": "1395c386.064e8c",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 630,
        "y": 480,
        "wires": []
    },
    {
        "id": "c293f39ddc15f47b",
        "type": "function",
        "z": "1395c386.064e8c",
        "name": "reset device data scope",
        "func": "let lastdata = global.get(\"LORIDANE.data\");\nconst findNode = global.get(\"LORIDANE.funcs.findNode\");\nlet datakeys = Object.keys(lastdata);\nlet newdata = {};\n\nfor (let key of datakeys) {\n    if(findNode(key) > -1){\n        newdata[key] = lastdata[key];\n    }\n}\nglobal.set(\"LORIDANE.data\", newdata);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1150,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "f59745225ff730e6",
        "type": "ui_button",
        "z": "1395c386.064e8c",
        "name": "",
        "group": "d7396f84.84707",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Reload Config",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "",
        "payloadType": "date",
        "topic": "topic",
        "topicType": "msg",
        "x": 230,
        "y": 140,
        "wires": [
            [
                "74934f3780837a8f"
            ]
        ]
    },
    {
        "id": "d7396f84.84707",
        "type": "ui_group",
        "name": "Server",
        "tab": "1809f267.7a279e",
        "order": 1,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "1809f267.7a279e",
        "type": "ui_tab",
        "name": "System",
        "icon": "fa-cog",
        "order": 5,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "ada10296.06249",
        "type": "subflow",
        "name": "LORIDANE - Send Timedisk",
        "info": "",
        "category": "Loridane",
        "in": [
            {
                "x": 100,
                "y": 120,
                "wires": [
                    {
                        "id": "e4d7b82.7ce1f48"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 820,
                "y": 120,
                "wires": [
                    {
                        "id": "6dc379ee.b0e338",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {
            "license": "GPL-3.0"
        },
        "color": "#3FADB5",
        "icon": "node-red-dashboard/ui_gauge.png",
        "status": {
            "x": 580,
            "y": 180,
            "wires": [
                {
                    "id": "3490e79c.716c88",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "e4d7b82.7ce1f48",
        "type": "function",
        "z": "ada10296.06249",
        "name": "Wait 5s",
        "func": "lastmsg = context.get(\"lastmsg\")||Date.now();\nnow = Date.now();\ncontext.set(\"lastmsg\",now);\ntimer = context.get(\"timer\");\nclearTimeout(timer);\ncontext.set(\"timer\",timer);\n\nfunction send(msg){\n    node.send(msg);\n}\n\nif(msg.topic == \"subito\"){\n    send(msg);\n}else{\n    timer = setTimeout(send,5000,msg);\n    context.set(\"timer\",timer);\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 220,
        "y": 120,
        "wires": [
            [
                "94811c76.73936"
            ]
        ]
    },
    {
        "id": "94811c76.73936",
        "type": "function",
        "z": "ada10296.06249",
        "name": "LORIDANE - TIMEDISK",
        "func": "const devices = global.get(\"LORIDANE.devices\");\nvar devicecount = devices.gw.length + devices.nodes.length;\nsf = devices.gw[0].sf;\n\n//timedisksize = Math.ceil((50 * 8 * Math.pow(2, sf))/(sf * 100000) * devicecount * 1000);\n\ntimedisksize = Math.ceil(((8 + ((400 - 4*sf + 28)/(4*sf)*5)) * Math.pow(2,sf)/(1e5)*1000)*devicecount);\n\nmsg.payload = {size:timedisksize,devicecount:devicecount};\nglobal.set([\"LORIDANE.timedisk.size\",\"LORIDANE.timedisk.count\"],[timedisksize,devicecount]);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 120,
        "wires": [
            [
                "6dc379ee.b0e338"
            ]
        ]
    },
    {
        "id": "6dc379ee.b0e338",
        "type": "function",
        "z": "ada10296.06249",
        "name": "send new Timedisk",
        "func": "let nodes = global.get(\"LORIDANE.devices.nodes\");\nconst gws = global.get(\"LORIDANE.devices.gw\");\nnodes = nodes.concat(gws); \nlastnodes = context.get(\"lastnodes\")||[];\ncontext.set(\"lastnodes\",nodes);\ntdsize = msg.payload.size;\nlet newtd = false;\nsubito = (msg.topic == \"subito\");\n//node.warn(subito) //debugging\nlet disk = {}; //global.get(\"LORIDANE.timedisk.disk\")||{};\nlet time;\nlet additionalDelay;\n(tdsize -10 < 1e5) ? additionalDelay = 100: additionalDelay = tdsize -30;\n\nsetTimeout(()=>node.status({}),5000);\n\nfunction senddelayed(obj){\n    node.send(obj);\n}\n\nif(lastnodes.length === 0){\n    for(i=0 , all = nodes.length; i < all ; i++){\n        if(nodes[i].uid != lastnodes[i].uid){\n            newtd = true;\n            break;\n        }\n    }\n}\n\nfind = global.get(\"LORIDANE.funcs.findNode\");\ngetconf = global.get(\"LORIDANE.funcs.getConfig\");\n\ncount = 0;\nnewtd = true;\nif (newtd && !subito){\n    time = 50;\n    sentUID = {};\n    for (var gw in gws){\n        obj = {payload:`cn:BL:1`,topic:`lora/${gws[gw].uid}`};\n        setTimeout(senddelayed,time,obj);\n        time += additionalDelay;\n        for (i=0;i<nodes.length;i++){\n            obj = {payload:`${nodes[i].uid}td:${count};${tdsize};`,topic:`lora/${gws[gw].uid}`};\n            if(sentUID[`${nodes[i].uid}`] === undefined){\n                setTimeout(senddelayed,time,obj);\n                time += additionalDelay;\n                disk[nodes[i].uid] = {uid:nodes[i].uid,slot:count,tdsize:tdsize};\n                sentUID[`${nodes[i].uid}`] = {};\n                sentUID[`${nodes[i].uid.count}`] = count;\n                count++;\n            }\n        }\n        obj = {payload:`cn:sync`,topic:`lora/${gws[gw].uid}`};\n        //setTimeout(senddelayed,time,obj);\n    }\n    node.status({text: \"Sent new Timedisk\"});\n}\nglobal.set(\"LORIDANE.timedisk.disk\",disk);\n\nfor (let gw in gws){\n    time += additionalDelay; \n    obj = {payload:`cn:BL:0`,topic:`lora/${gws[gw].uid}`};\n    setTimeout(senddelayed,time,obj);\n    \n}\n\n\nif(subito){\n    devs = global.get(\"LORIDANE.classA\");\n    getconf = global.get(\"LORIDANE.funcs.getConfig\");\n    for (var dev of devs){\n        if(disk[dev] !== undefined){\n            //node.warn(disk)\n            obj = {payload:`${dev}td:${disk[dev].slot};${disk[dev].tdsize};`,topic:`lora/${getconf(dev).nextGW}`};\n            senddelayed(obj);\n        }\n    }\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 120,
        "wires": [
            []
        ],
        "info": "let nodes = global.get(\"LORIDANE.devices.nodes\");\nconst gws = global.get(\"LORIDANE.devices.gw\");\nnodes = nodes.concat(gws); \nlastnodes = context.get(\"lastnodes\")||[];\ncontext.set(\"lastnodes\",nodes);\ntdsize = msg.payload.size;\nlet newtd = false;\nsubito = (msg.topic == \"subito\");\n//node.warn(subito) //debugging\nlet disk = {}; //global.get(\"LORIDANE.timedisk.disk\")||{};\n\nlet additionalDelay;\n(tdsize -10 < 1e5) ? additionalDelay = 50: additionalDelay = tdsize -10;\n\nsetTimeout(()=>node.status({}),5000);\n\nfunction senddelayed(obj){\n    node.send(obj);\n}\n\nif(lastnodes.length === 0){\n    for(i=0 , all = nodes.length; i < all ; i++){\n        if(nodes[i].uid != lastnodes[i].uid){\n            newtd = true;\n            break;\n        }\n    }\n}\n\nfind = global.get(\"LORIDANE.funcs.findNode\");\ngetconf = global.get(\"LORIDANE.funcs.getConfig\");\n\ncount = 0;\nnewtd = true;\nif (newtd && !subito){\n    time = 50;\n    sentUID = {};\n    for (var gw in gws){\n        for (i=0;i<nodes.length;i++){\n            obj = {payload:`${nodes[i].uid}td:${count};${tdsize};`,topic:`lora/${gws[gw].uid}`};\n            if(sentUID[`${nodes[i].uid}`] === undefined){\n                setTimeout(senddelayed,time,obj);\n                time += additionalDelay;\n                disk[nodes[i].uid] = {uid:nodes[i].uid,slot:count,tdsize:tdsize};\n                sentUID[`${nodes[i].uid}`] = {};\n                sentUID[`${nodes[i].uid.count}`] = count;\n                count++;\n            }\n        }\n        obj = {payload:`cn:sync`,topic:`lora/${gws[gw].uid}`};\n        setTimeout(senddelayed,time,obj);\n    }\n    node.status({text: \"Sent new Timedisk\"});\n}\nglobal.set(\"LORIDANE.timedisk.disk\",disk);\n\nif(subito){\n    devs = global.get(\"LORIDANE.classA\");\n    getconf = global.get(\"LORIDANE.funcs.getConfig\");\n    for (var dev of devs){\n        if(disk[dev] !== undefined){\n            //node.warn(disk)\n            obj = {payload:`${dev}td:${disk[dev].slot};${disk[dev].tdsize};`,topic:`lora/${getconf(dev).nextGW}`};\n            senddelayed(obj);\n        }\n    }\n}\n\nreturn;"
    },
    {
        "id": "3490e79c.716c88",
        "type": "status",
        "z": "ada10296.06249",
        "name": "",
        "scope": null,
        "x": 460,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "6d6bd93a.e97668",
        "type": "inject",
        "z": "ada10296.06249",
        "name": "New timedisk manual trigger",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 200,
        "y": 180,
        "wires": [
            [
                "e4d7b82.7ce1f48"
            ]
        ]
    },
    {
        "id": "6712fbef.2d8494",
        "type": "subflow",
        "name": "LORIDANE - Acknowledge",
        "info": "",
        "category": "Loridane",
        "in": [
            {
                "x": 240,
                "y": 80,
                "wires": [
                    {
                        "id": "1a746dcd.d51fd2"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 480,
                "y": 80,
                "wires": [
                    {
                        "id": "1a746dcd.d51fd2",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {
            "license": "GPL-3.0"
        },
        "color": "#3FADB5",
        "icon": "font-awesome/fa-cloud-download",
        "status": {
            "x": 520,
            "y": 160,
            "wires": [
                {
                    "id": "1d0625f6.98bf6a",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "1a746dcd.d51fd2",
        "type": "function",
        "z": "6712fbef.2d8494",
        "name": "Acknowledge",
        "func": "data = msg.data;\n//const devs = global.get(\"LORIDANE.devices\");\n\n// if Lora msg payload is Node UID its an acknowledgement\nif (msg.data.pay == msg.data.node){\n    msg.topic = \"acknowledge\";\n    node.status({text:\"New Device found\"});\n    \n}\nnode.status({});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "1d0625f6.98bf6a",
        "type": "status",
        "z": "6712fbef.2d8494",
        "name": "",
        "scope": null,
        "x": 420,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "4e984df.de567b4",
        "type": "subflow",
        "name": "LORIDANE - MQTT In",
        "info": "",
        "category": "Loridane",
        "in": [],
        "out": [
            {
                "x": 520,
                "y": 120,
                "wires": [
                    {
                        "id": "1c0ac556.46e25b",
                        "port": 0
                    }
                ]
            },
            {
                "x": 920,
                "y": 120,
                "wires": [
                    {
                        "id": "f023d975.deb8d8",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1400,
                "y": 60,
                "wires": [
                    {
                        "id": "af3bda90.002258",
                        "port": 0
                    },
                    {
                        "id": "b3b76bf0.aef8c8",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {
            "license": "GPL-3.0"
        },
        "color": "#3FADB5",
        "outputLabels": [
            "raw data output",
            "processed Payload",
            "conditional output, acknowledgement and Class A Devices "
        ],
        "icon": "node-red/bridge.svg",
        "status": {
            "x": 640,
            "y": 40,
            "wires": [
                {
                    "id": "f7a51ace.7907f8",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "5766fe05.480f8",
        "type": "mqtt in",
        "z": "4e984df.de567b4",
        "name": "",
        "topic": "lora/gateway/#",
        "qos": "1",
        "datatype": "utf8",
        "broker": "3be33484.0e776c",
        "nl": false,
        "rap": true,
        "rh": 0,
        "x": 100,
        "y": 40,
        "wires": [
            [
                "6a479509.a7889c"
            ]
        ]
    },
    {
        "id": "6a479509.a7889c",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "Process incoming Data",
        "func": "let raw = msg.payload;\nif(raw === \"pong\")return;\nlet lastmsgs = context.get(\"lastmsgs\")||[];\nconst now  = Date.now();\nconst decrypt = global.get(\"LORIDANE.funcs.decrypt\");\n\n//node.warn(raw)\nfunction extractID(pay){\n    let len = 14;\n    this.node = pay.slice(0,len);\n    this.pay = pay.slice(len,pay.length);\n    return this;\n}\n\n\nlet input;\n//*/Variant 1 raw json\nif(raw.startsWith(\"{\")){\n    //*/Variant 1 object\n    if(raw.includes('\"payload\":\"NO')){\n        try{\n            input = JSON.parse(raw);\n        }catch(e){\n            node.warn('There is something wrong with the JSON (Line 38)')\n        }\n    }else{\n        try{\n            input = JSON.parse(raw);\n        }catch(e){\n            node.warn(`There is something wrong with the JSON (Line 51) ERR: ${e}`)\n        }\n        let plain;\n        //node.warn(input)\n        plain = decrypt(input.payload);\n        input.payload = plain;\n        \n    }\n        //node.warn(message)\n    \n    nodedata = input.payload;\n    gateway = input.gw;\n    RSSI = input.rssi;\n    SNR = input.snr;\n    SF = input.sf;\n    freq = input.freq;\n    payload = (isNaN(extractID(nodedata).pay))? extractID(nodedata).pay : parseFloat(extractID(nodedata).pay);\n    node = extractID(nodedata).node;\n    \n}else{\n    // Extract the data from the LoRa msg if ;-split string\n    input  = msg.payload.split(\";\");\n    nodedata = input[0];\n    if(!nodedata.startsWith(\"NO\")){\n        const decrypt = global.get(\"LORIDANE.funcs.decrypt\");\n        nodedata = decrypt(nodedata);\n    }\n    gateway = extractID(input[1]).node;\n    RSSI = parseInt(input[2]);\n    SNR = parseFloat(input[3]);\n    SF = parseInt(input[4]);\n    freq = parseInt(input[5]);\n    payload = extractID(nodedata).pay;\n    node = extractID(nodedata).node;\n}\n\nignorelist = global.get(\"LORIDANE.ignorelist\")||[];\nignore = (ignorelist.indexOf(node) != -1 || ignorelist.indexOf(gateway) != -1);\nif(ignore)return;\nmsg.data = {};\n// object that takes all data from the msg\nmsg.data = {\n    pay: payload,\n    gw: gateway,\n    node: node,\n    freq: freq,\n    sf: SF,\n    rssi: RSSI,\n    snr: SNR,\n    lastSeen: now,\n};\n  \n//object that will be passed through the core nodes\nmsg.config = {\n    gw: gateway,\n    node: node,\n    freq: freq,\n    sf: SF,\n    lastSeen: now,\n};\nmsg.raw = raw; // the raw LoRa msg\nmsg.payload = payload; // the actual payload\nlet paylens = global.get(\"LORIDANE.values.lastPayloadLens\")||{historic:[],mean:50,toa:83,minInterval:4000};\nconst getMean = global.get(\"LORIDANE.funcs.math.getMean\");\nconst timeOnAir = global.get(\"LORIDANE.funcs.timeOnAir\");\nconst minInterval = global.get(\"LORIDANE.funcs.minInterval\");\n\nif(!isNaN(payloadLength = nodedata.toString().length) ){\n    paylens.historic.unshift(payloadLength);\n    if(paylens.historic.length > 60){\n    paylens.historic.pop();\n    }\n}\n\npaylens.mean = getMean(paylens.historic);\npaylens.toa = timeOnAir(paylens.mean,SF);\npaylens.minInterval = minInterval();\nglobal.set(\"LORIDANE.values.lastPayloadLens\", paylens);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "// Der Code hier wird ausgeführt,\n// wenn der Node gestoppt wird\nwriteConfig = global.get(\"LORIDANE.funcs.writeConfig\");\nwriteConfig();\nreturn;",
        "libs": [],
        "x": 250,
        "y": 100,
        "wires": [
            [
                "1c0ac556.46e25b"
            ]
        ],
        "info": "decrypts the payload if encrypted\nchecks whether the node or the gateway are on ignore list -> drops the msg\nreassmbles the msg\n"
    },
    {
        "id": "f7a51ace.7907f8",
        "type": "status",
        "z": "4e984df.de567b4",
        "name": "",
        "scope": [
            "5766fe05.480f8",
            "6a479509.a7889c",
            "f023d975.deb8d8",
            "ace12ad7.be1258",
            "e8e230ba.be0de",
            "1c0ac556.46e25b",
            "bb9d0db9.4979b",
            "c4a84594.067618",
            "45de5a13.5445f4",
            "b2d51542.edd3b8",
            "5e2b324a.5f839c",
            "3d42dae8.ad8c96",
            "6778ed4.7aa9a14",
            "340c50f1.6dadc",
            "38d8c130.658fee"
        ],
        "x": 520,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "f023d975.deb8d8",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "msg.data.pay to msg.payload",
        "func": "let payload = msg.data.pay;\nconst checkUID = global.get(\"LORIDANE.funcs.checkUID\");\n\nif(payload == \"+\")return;\nif(!checkUID(msg.data.node))return;\n\ntopic = msg.topic;\n\n//cut the data object to the minimum\nmsg = {payload:payload, topic:topic, data:msg.data, config:msg.config};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 180,
        "wires": [
            [
                "bb9d0db9.4979b",
                "af3bda90.002258",
                "10aa9bc2.dd3dd4",
                "b3b76bf0.aef8c8"
            ]
        ],
        "info": "drops the msg if the uid is not valid"
    },
    {
        "id": "ace12ad7.be1258",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "Confirmation of configuration messages via '+' payload",
        "func": "if(msg.data.pay != \"+\")return;\n\nfunction getNextGW(uid){\n    nodes = global.get(\"LORIDANE.devices.nodes\");\n    for (var device in nodes){\n        if (nodes[device].uid === uid){\n            return nodes[device].nextGW;\n        }\n        return undefined;\n    }\n}\n\nlet confirm = global.get(\"LORIDANE.confirm\");\nnow = Date.now();\nfrom = msg.data.node;\nsize = global.get(\"LORIDANE.timedisk.size\");\n\nfor(i=0;i<confirm.length;){\n    if(from == confirm[i].uid && msg.data.pay == \"+\") {\n        confirm.splice(i,1);\n        global.set(\"LORIDANE.confirm\",confirm);\n    }else if(now - confirm[i].time >= 5*size){\n        msg = {payload: confirm[i].out, topic:\"lora/\"+getNextGW(from)};\n        confirm.splice(i,1);\n        global.set(\"LORIDANE.confirm\",confirm);\n        node.send(msg);\n    }else if(now - confirm[i].time >= 10*size){\n        confirm.splice(i,1);\n        global.set(\"LORIDANE.confirm\",confirm);\n    }else{\n        i++;\n    }\n}\nglobal.set(\"LORIDANE.confirm\",confirm);\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 300,
        "wires": [
            [
                "a918650.4c9da98"
            ]
        ]
    },
    {
        "id": "a918650.4c9da98",
        "type": "subflow:2fad0fdc.1d24b",
        "z": "4e984df.de567b4",
        "name": "",
        "env": [],
        "x": 820,
        "y": 460,
        "wires": []
    },
    {
        "id": "e8e230ba.be0de",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "decrypt",
        "func": "if(global.get(\"LORIDANE.settings.encryption.engaged\") !== true) return msg;\n\n// Only decrypt when payload is ciphered\nconst cr = global.get(\"crjs\")\nconst crypt = global.get(\"LORIDANE.settings.encryption\")\nconst iv = crypt.iv\nconst key = crypt.key\n\nvar bytes  = cr.AES.decrypt( msg.data.pay, key, {\n  iv: iv,\n  mode: cr.mode.CBC,\n  padding: cr.pad.ZeroPadding\n});\n\nvar plaintext = bytes.toString(cr.enc.Utf8); //Base64\nmsg.data.pay = plaintext;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "1c0ac556.46e25b",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "filter msg from multiple gw",
        "func": "lastmsgs = context.get(\"lastmsgs\")||[];\nconst newmsg = msg;\nlet timer = context.get(\"timer\");\nclearTimeout(timer);\ncontext.set(\"timer\",timer);\nlet newmsgbool;\n\nfunction send(lastmsgs){\n    for(var msg of lastmsgs){\n        node.send(msg)\n    }\n    context.set(\"lastmsgs\",[]);\n}\n\nnow = Date.now();\nif(lastmsgs != []){\n    newmsgbool = true;\n    for (ms=0;ms<lastmsgs.length;/**only increment in else*/){\n        if(now - lastmsgs[ms].data.lastSeen >= 100){\n            lastmsgs.splice(ms,1);\n        }else{\n            ms++;\n        }\n    }\n\n    for (ms=0;ms<lastmsgs.length;/**only increment in else*/){\n        if(newmsg.data.pay == lastmsgs[ms].data.pay && newmsg.data.node == lastmsgs[ms].data.node){\n            newmsgbool = false;\n            if(newmsg.data.rssi > lastmsgs[ms].data.rssi && now - lastmsgs[ms].data.lastSeen <= 100){\n                lastmsgs[ms] = newmsg;\n                break;\n            }\n        }\n        ms++;\n    }\n}\n\nif(newmsgbool)lastmsgs.push(newmsg);\ncontext.set(\"lastmsgs\",lastmsgs);\ntimer = setTimeout(send,100,lastmsgs);\ncontext.set(\"timer\",timer);\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 270,
        "y": 140,
        "wires": [
            [
                "f023d975.deb8d8",
                "ace12ad7.be1258"
            ]
        ],
        "info": "if there are more than one gateway\nwhich one had the better rssi?\ndrop the msg from the latter gateway"
    },
    {
        "id": "bb9d0db9.4979b",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "admit",
        "func": "node = msg.data.node;\ngw = msg.data.gw;\npayload = msg.payload;\n\nfindGW = global.get(\"LORIDANE.funcs.findGW\");\nfindNode = global.get(\"LORIDANE.funcs.findNode\");\nadmit = global.get(\"LORIDANE.admit\")||[];\ncheckUID = global.get(\"LORIDANE.funcs.checkUID\");\n\n\nindexgw = findGW(gw);\nindexnode = findNode(node);\n\nUIDvalid = (checkUID(node) && checkUID(gw));\nif((indexgw >= 0 && indexnode >= 0) || !UIDvalid )return;\n\nif(indexgw == -1){\n    admit.push(gw);\n}\n\nif(indexnode == -1){\n    if(payload == node){\n        admit.push(node);\n    }\n}\n\nglobal.set(\"LORIDANE.admit\",admit);\n\nif(admit.length > 0){\n    msg.admit = admit;\n    return msg;\n}\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 180,
        "wires": [
            [
                "38d8c130.658fee",
                "c4a84594.067618"
            ]
        ],
        "info": "brings the device to the admission list, if it is unknown"
    },
    {
        "id": "38d8c130.658fee",
        "type": "ui_toast",
        "z": "4e984df.de567b4",
        "position": "dialog",
        "displayTime": "6",
        "highlight": "",
        "sendall": true,
        "outputs": 1,
        "ok": "OK, Change Tab",
        "cancel": "Later",
        "raw": false,
        "topic": "New Devices ask for Admittance",
        "name": "Admittance",
        "x": 1090,
        "y": 160,
        "wires": [
            [
                "340c50f1.6dadc"
            ]
        ]
    },
    {
        "id": "340c50f1.6dadc",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "change tab to ADMITTANCE",
        "func": "if(msg.payload != \"OK, Change Tab\")return;\nmsg.payload = {\"tab\":\"Admittance\"}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1340,
        "y": 160,
        "wires": [
            [
                "6778ed4.7aa9a14"
            ]
        ]
    },
    {
        "id": "6778ed4.7aa9a14",
        "type": "ui_ui_control",
        "z": "4e984df.de567b4",
        "name": "",
        "events": "all",
        "x": 1740,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "3d42dae8.ad8c96",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "change tab to MSGS",
        "func": "msg.payload = {\"tab\":\"Messages\"}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1180,
        "y": 280,
        "wires": [
            [
                "5e2b324a.5f839c",
                "6778ed4.7aa9a14"
            ]
        ],
        "info": "changes the ui tab automatically if the user wants to admit a new device"
    },
    {
        "id": "89c2a1bf.a0465",
        "type": "ui_dropdown",
        "z": "4e984df.de567b4",
        "name": "admit dropdown",
        "label": "",
        "tooltip": "",
        "place": "Select Devices To Admit, The Rest Will Be Tossed!",
        "group": "11c9f05.acda51",
        "order": 6,
        "width": 0,
        "height": 0,
        "passthru": false,
        "multiple": true,
        "options": [],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "x": 1120,
        "y": 240,
        "wires": [
            [
                "3d42dae8.ad8c96",
                "45de5a13.5445f4"
            ]
        ]
    },
    {
        "id": "c4a84594.067618",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "set msg options to msg admit",
        "func": "return {options:msg.admit};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1035,
        "y": 200,
        "wires": [
            [
                "89c2a1bf.a0465"
            ]
        ],
        "l": false
    },
    {
        "id": "45de5a13.5445f4",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "save admission",
        "func": "let wantAdmittance = global.get(\"LORIDANE.admit\");\nlet admitted = msg.payload;\nconst findGW = global.get(\"LORIDANE.funcs.findGW\");\nconst findNode = global.get(\"LORIDANE.funcs.findNode\");\nconst deleteDevice = global.get(\"LORIDANE.funcs.deleteDevice\");\nconst writeConfig = global.get(\"LORIDANE.funcs.writeConfig\");\nlet ignorelist = global.get(\"LORIDANE.ignorelist\");\n\nfor (var device of wantAdmittance){\n    if(admitted.indexOf(device) >= -1){\n        wantAdmittance.splice(wantAdmittance.indexOf(device),1);\n    }\n}\n\n\nfor(device of wantAdmittance){\n    deleteDevice(device)\n    ignorelist.push(device)\n}\nglobal.set([\"LORIDANE.admit\",\"LORIDANE.ignorelist\"],[[],ignorelist]);\nwriteConfig();\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1380,
        "y": 220,
        "wires": [
            []
        ],
        "info": "if a new device gets admitted save it\nelse set it to the ignorelist"
    },
    {
        "id": "b2d51542.edd3b8",
        "type": "debug",
        "z": "4e984df.de567b4",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 810,
        "y": 260,
        "wires": []
    },
    {
        "id": "5e2b324a.5f839c",
        "type": "ui_toast",
        "z": "4e984df.de567b4",
        "position": "top right",
        "displayTime": "5",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "topic": "Admitted!",
        "name": "admission notification",
        "x": 1690,
        "y": 300,
        "wires": []
    },
    {
        "id": "af3bda90.002258",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "new timedisk when acknowledge",
        "func": "if(msg.payload != msg.data.node)return;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1060,
        "y": 80,
        "wires": [
            []
        ],
        "info": "trigger a new timdisk, when a device gets acknowledged"
    },
    {
        "id": "10aa9bc2.dd3dd4",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "reset interval",
        "func": "if (msg.data.pay != msg.data.node)return;\n\nfunction sendDelay(msg){\n    node.send(msg);\n}\n\nconst find = global.get(\"LORIDANE.funcs.findNode\");\nconst getConfig = global.get(\"LORIDANE.funcs.getConfig\");\nlet UID = msg.data.node;\nconst getGWs = global.get(\"LORIDANE.funcs.getUIDGW\");\n\nlet index = find(UID);\nif(index == -1)return;\n\nconst interval = Math.floor(getConfig(UID).lastinterval / 1000) * 1000;\n\nif (interval < 5000)return;\nlet gateways  = getGWs();\n\nmsg.payload = UID+\"iv:\"+interval;\nfor(var gw of gateways){\n    msg.topic = \"lora/\"+gw;\n    setTimeout(sendDelay,15000,msg);\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 220,
        "wires": [
            [
                "a918650.4c9da98",
                "b2d51542.edd3b8"
            ]
        ],
        "info": "reset the node interval to the last known if a node comes online again"
    },
    {
        "id": "b3b76bf0.aef8c8",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "timedisk to classA",
        "func": "classA = global.get(\"LORIDANE.classA\")||[];\nif(classA.indexOf(msg.data.node) != -1){\n    msg.topic = \"subito\";\n    //node.warn(\"Subito!\")\n    return msg;\n}\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 990,
        "y": 40,
        "wires": [
            []
        ],
        "info": "if a device is in the classA list, it has to be acknowledged immediately"
    },
    {
        "id": "088ce0e8085dd6d5",
        "type": "function",
        "z": "4e984df.de567b4",
        "name": "analyse Buffer",
        "func": "paystartindex = msg.payload.indexOf(\n    Buffer.from([0x6c,0x6f,0x61,0x64,0x22,0x3a,0x22])\n    ) + 7; // = load\":\"\npayendindex = msg.payload.indexOf(\n    Buffer.from([0x22,0x2c,0x22,0x67,0x77])\n    ); // = \",\"gw:\n    \nlet inString = msg.payload.toString();\nmsg.startindex = paystartindex;\nmsg.endindex = payendindex;\n\nif (msg.payload[paystartindex] == 0x4e && msg.payload[paystartindex+1] == 0x4f){ // payload starts with NO\n    msg.payload = inString;\n    return msg;\n}else{\n    let cipher = inString.slice(paystartindex, payendindex);\n    msg.cipher = Buffer.from(cipher);\n    msg.payload = inString.slice(0,paystartindex) + inString.slice(payendindex+1);\n    return msg;\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 180,
        "y": 560,
        "wires": [
            []
        ],
        "info": "receives:\na byte buffer via mqtt\nextracts the payload\nchecks whether the pay is encyrpted or not\nextracts it\nreassembles the msg\nreturns the msg without payload and the payload extra"
    },
    {
        "id": "11c9f05.acda51",
        "type": "ui_group",
        "name": "Admit Node",
        "tab": "3dfe0b0a.ecf364",
        "order": 1,
        "disp": true,
        "width": "8",
        "collapse": false
    },
    {
        "id": "3dfe0b0a.ecf364",
        "type": "ui_tab",
        "name": "Admittance",
        "icon": "key",
        "order": 7,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "2fad0fdc.1d24b",
        "type": "subflow",
        "name": "LORIDANE - Downlink",
        "info": "",
        "category": "Loridane",
        "in": [
            {
                "x": 120,
                "y": 100,
                "wires": [
                    {
                        "id": "1a95a2d5.655b3d"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {
            "license": "GPL-3.0"
        },
        "color": "#3FADB5",
        "icon": "node-red/bridge-dash.svg",
        "status": {
            "x": 580,
            "y": 160,
            "wires": [
                {
                    "id": "1792be97.4020f1",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "90cd8175.15ea4",
        "type": "mqtt out",
        "z": "2fad0fdc.1d24b",
        "name": "",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3be33484.0e776c",
        "x": 650,
        "y": 100,
        "wires": []
    },
    {
        "id": "d505a1dd.b771d",
        "type": "function",
        "z": "2fad0fdc.1d24b",
        "name": "Test Downlink",
        "func": "function checkdevices(arr,fun){\n    for (var j in array){\n        if (!fun(arr[j]) || !arr[j].startsWith(\"NO:\")){\n            node.error(`The Device @Index ${j} \"${arr[j]}\" is no valid DeviceUID`);\n            return false;\n        }\n        return true;\n    }\n}\n\nlet inData = msg.payload;\n\nif(typeof(inData) == \"string\"){\n    return msg;\n}\n\nlet downdataNO = \"\";\nlet downdataGW = \"\";\nlet checkUID = global.get(\"funcs.checkUID\");\nlet deffreq = (msg.freq !== undefined);\nlet defsf = (msg.sf !== undefined);\nlet deftx =  (msg.tx !== undefined);\nlet defdevice = (msg.device !== undefined);\nlet prefix = \"\";\n\nif(!defdevice){\n    node.warn(\"Invalid msg.device\");\n}\nif(!msg.topic.startsWith(\"lora/\")){\n    node.warn(\"Invalid msg.topic\");\n}\n\nif(msg.device.length == 1 && msg.device[0].length >= 1 && checkdevices(msg.device[0],checkUID)){\n   for (var i of msg.devices[0]){\n    node.send({payload: i+downDataNO,topic:msg.topic});\n   }\n}\n\nif(msg.device.includes(\"nodes\")){\n    prefix += \"cn:\";\n    if (deffreq){\n        downdataNO += \"fn:\"+msg.freq+\";\";\n    }\n    if (defsf){\n        downdataNO += \"sn:\"+msg.sf+\";\";\n    }\n    if(deftx){\n        downdataNO += \"tn:\"+msg.tx+\";\";\n    }\n}\n\nif(msg.device.includes(\"gateways\")){\n    prefix += \"cg:\";\n     if (deffreq){\n        downdataGW += \"fg:\"+msg.freq+\";\";\n    }\n    if (defsf){\n        downdataGW += \"sg:\"+msg.sf+\";\";\n    }\n    if(deftx){\n        downdataGW += \"tg:\"+msg.tx+\";\";\n    }\n}\nnode.send({payload: prefix + downdataNO + downdataGW ,topic:msg.topic});\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 260,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "1a95a2d5.655b3d",
        "type": "function",
        "z": "2fad0fdc.1d24b",
        "name": "Send in Timerframe",
        "func": "function sendmsg(msg){\n    node.send(msg)\n}\n\nfunction getSendTime(UID){\n    const findGW = global.get(\"LORIDANE.funcs.findGW\");\n    const gws = global.get(\"LORIDANE.devices.gw\") || [0];\n    let amountOfGws = gws.length; //defaults to 1\n    const indexGW = findGW(UID);\n    const sf = global.get(\"LORIDANE.devices.gw[0].sf\") || 7;\n    let sendtime = size - timeOnAir(50,sf) * (amountOfGws-indexGW);\n    return sendtime;\n}\n\nconst timeOnAir = global.get(\"LORIDANE.funcs.timeOnAir\");\n\n//-----------------------------------------------------------------\n// load needed data from context\nconst now = Date.now();\nconst sf = global.get(\"LORIDANE.devices.gw[0].sf\")||7;\nconst TS_SYNC = [19,34,61,111,206,386];\n\nlet lastmsg = context.get(\"lastmsg\")||0;\nlet startDisk = context.get(\"startDisk\")||lastmsg;\n\nlet timedisk = global.get(\"LORIDANE.timedisk\")||{size:1500,count:5};\nlet size = timedisk.size;\nlet timeinframe = (now-startDisk) % size;\n\nlet UID = msg.topic.substring(msg.topic.indexOf(\"GW\"), msg.topic.indexOf(\"GW\") + 14);\nlet sendtime = getSendTime(UID);\nlet untilsend = size - sendtime - timeinframe;\n\n// check when the timeframe for the gateway is reached\nif (msg.payload.includes('td:')) {\n    sendmsg(msg);\n}else{\n    if(timeinframe > sendtime - timeOnAir(30,sf) || untilsend < 0){\n    untilsend = 2 * size - timeinframe - sendtime;\n    setTimeout(sendmsg,untilsend,msg);\n    }else{\n    setTimeout(sendmsg,untilsend,msg);\n    node.status({text:\"Delayed msg for \"+untilsend+\" ms\"});\n    }    \n}\n\n\n\ncontext.set(\"lastmsg\",now + untilsend);\n\n//check if in the to be confirmed array is old data\nlet confirm = global.get(\"LORIDANE.confirm\")||[];\nif (confirm.length > 0){\n    for(var con in confirm){\n        if(now - confirm[con].time >= 10*size){\n            confirm.splice(con,1);\n        }\n    }\n}\n\n//save outgoing msgs to the confirmation scope\nif(msg.payload.startsWith(\"NO\")){\n    obj = {uid: msg.payload.substring(0,14), out:msg.payload, time: now};\n    confirm.push(obj);\n}\n//except sync msgs\nif(msg.payload.includes(\"cn:\")){\n    if (!msg.payload.includes(\"sync\")){\n        nodes = global.get(\"LORIDANE.devices.nodes\");\n        for(var nd in nodes){\n            obj = {uid: nodes[nd].uid, out:msg.payload, time: now};\n            confirm.push(obj);\n        }\n    }else{\n        context.set(\"startDisk\",now+untilsend+TS_SYNC[sf-7]);\n    }\n    \n}\nglobal.set(\"LORIDANE.confirm\",confirm);\n\nnode.status({text:\"Delayed msg for \"+untilsend+\" ms\"});\nsetTimeout(() => node.status({text:\"\"}),3000);\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 100,
        "wires": [
            [
                "90cd8175.15ea4"
            ]
        ]
    },
    {
        "id": "1792be97.4020f1",
        "type": "status",
        "z": "2fad0fdc.1d24b",
        "name": "",
        "scope": null,
        "x": 470,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "3be33484.0e776c",
        "type": "mqtt-broker",
        "name": "",
        "broker": "192.168.4.1",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "sessionExpiry": ""
    },
    {
        "id": "364ae788.0e6328",
        "type": "subflow",
        "name": "LORIDANE - Save new devices",
        "info": "Accepts two Inputs:\n - MQTT in listening to lora/gateway#\n - Inject node or similar that sends a\n    msg.topic of \"syncfrequency\"\n    if the gateway should listen to the standard frequency of 867MHz for 10 seconds at SF7\n\nIt then will add a configuration-file\nto /home/pi/gateway/\nfor each new Node\n\nIt has 3 Outputs:\n\n 1) Contains every (processed) message the MQTT In      receives in msg.data.\n 2) Should be conected to\n    \"Load Configuration from Files\", if that is wanted\n 3) Received Raw MQTT on msg.payload\n    and the configuration Data if new device binding is initiated via msg.topic = \"syncfrequency\"",
        "category": "Loridane",
        "in": [
            {
                "x": 80,
                "y": 240,
                "wires": [
                    {
                        "id": "82c27a6c.0a2258"
                    },
                    {
                        "id": "77abdcc2.fad7c4"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 940,
                "y": 220,
                "wires": [
                    {
                        "id": "aecffc67.3d552",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {
            "license": "GPL-3.0"
        },
        "color": "#3FADB5",
        "icon": "node-red/leveldb.png",
        "status": {
            "x": 420,
            "y": 380,
            "wires": [
                {
                    "id": "bd6188af.c82468",
                    "port": 0
                }
            ]
        }
    },
    {
        "id": "bd6188af.c82468",
        "type": "status",
        "z": "364ae788.0e6328",
        "name": "",
        "scope": [
            "f9389fb4.1d491"
        ],
        "x": 320,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "82c27a6c.0a2258",
        "type": "function",
        "z": "364ae788.0e6328",
        "name": "add new node",
        "func": "//if (msg.friendlyname !== undefined){return}\n\nblock = flow.get(\"block\")|| false;\ngateways = global.get(\"LORIDANE.devices.gw\")||[];\nsetTimeout(()=> node.status({}),5000);\n\nfunction sendDelayed(arr){\n    node.send(arr);\n}\n\n//reset the config of the gateway after 10 secs to values before\nfunction resetConfig(){\n    flow.set(\"block\",false);\n    gateways = flow.get(\"lastGatewayParams\")||[];\n    flow.set(\"lastGatewayParams\",[]);\n    \n    for(var gateway in gateways){\n    node.send([null,{payload:`cg:fg:${gateways[gateway].freq / 100000};sg:${gateways[gateway].sf};`,topic:`lora/${gateways[gateway].uid}`}]);\n    }\n    node.status({text:`Reset Configuration to: \"cg:fg:${gateways[gateway].freq / 100000};sg:${gateways[gateway].sf};\"`});\n    \n}\n\nlet timer;\nlet gateway;\n\n\nif((msg.topic != \"syncfrequency\" || msg.topic != \"acknowledge\" ) && block){\n    node.status({text:\"Blocked and Waiting for New Devices\"});\n    return;\n}else if(msg.topic == \"syncfrequency\"){\n    flow.set(\"block\",true);\n    flow.set(\"lastGatewayParams\",gateways),\n    timer = clearTimeout(timer);\n    //gateways = global.get(\"LORIDANE.devices.gw\");\n\n    for(gateway in gateways){\n        node.send([null,{payload:\"cg:fg:8670;sg:7;\",topic:`lora/${gateways[gateway].uid}`}]);\n        setTimeout(sendDelayed,500,[null,{payload:`cn:fn:${gateways[gateway].freq / 100000};sn:${gateways[gateway].sf};`,topic:`lora/${gateways[gateway].uid}`}]);\n    }\n    node.status({text:`Configuration Sent to GWs: \"cg:fg:8670;sg:7;\"`});\n    timer = setTimeout(resetConfig,10500);\n    flow.set(\"timer\",timer);\n    return;\n}else if(msg.topic == \"acknowledge\"){\n    node.send([msg,null]);\n    flow.set(\"block\",true);\n    flow.set(\"lastGatewayParams\",gateways),\n    timer = clearTimeout(timer);\n    gateways = global.get(\"LORIDANE.devices.gw\");\n    msg.data.pay = -1;\n    \n    if (gateways != []){\n        for(gateway in gateways){\n            node.send([msg,{payload:`cn:fn:${gateways[gateway].freq / 100000};sn:${gateways[gateway].sf};`,topic:`lora/${gateways[gateway].uid}`}]);\n        }\n    }else{\n        node.send([msg,{payload:`cn:fn:${msg.data.freq / 100000};sn:${msg.data.sf};`,topic:`lora/${msg.data.gw}`}]);\n    }\n    node.status({text:`Configuration Sent to GWs: \"cg:fg:8670;sg:7;\"`});\n    timer = setTimeout(resetConfig,10500);\n    flow.set(\"timer\",timer);\n    return;\n}\n\nnode.status({text:\"Passthrough Mode\"});\n\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 240,
        "wires": [
            [
                "4a21c374.73a2cc",
                "4caa54e54d0ec49a"
            ],
            [
                "3a9e2be5.c14f04"
            ]
        ]
    },
    {
        "id": "4a21c374.73a2cc",
        "type": "function",
        "z": "364ae788.0e6328",
        "name": "return if null",
        "func": "if(msg === null){\n    return;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 575,
        "y": 240,
        "wires": [
            [
                "aecffc67.3d552"
            ]
        ],
        "l": false
    },
    {
        "id": "3a9e2be5.c14f04",
        "type": "function",
        "z": "364ae788.0e6328",
        "name": "return if null 2",
        "func": "if(msg === null){\n    return;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 575,
        "y": 280,
        "wires": [
            [
                "7b5b0ef.0d0a9f"
            ]
        ],
        "l": false
    },
    {
        "id": "7b5b0ef.0d0a9f",
        "type": "subflow:2fad0fdc.1d24b",
        "z": "364ae788.0e6328",
        "name": "",
        "env": [],
        "x": 720,
        "y": 280,
        "wires": []
    },
    {
        "id": "77abdcc2.fad7c4",
        "type": "function",
        "z": "364ae788.0e6328",
        "name": "save friendlyname",
        "func": "if (msg.friendlyname === undefined){\n    return;\n}\n//const USER = global.get(\"LORIDANE.LinuxUsername\");\nconst gws = global.get(\"LORIDANE.devices.gw\");\nlet nds = global.get(\"LORIDANE.devices.nodes\");\n\n// check which device the friendly name update concerns by uid\nfor (var gw in gws){\n    if (msg.friendlyname.uid == gws[gw].uid){\n        gws[gw].friendlyname = msg.friendlyname.name;\n    }\n}\n\nfor (var nd in nds){\n    if (msg.friendlyname.uid == nds[nd].uid){\n        nds[nd].friendlyname = msg.friendlyname.name;\n    }\n}\nglobal.set([\"LORIDANE.devices.gw\",\"LORIDANE.devices.nodes\"],[gws,nds]);\n\nreturn {filename:true};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 340,
        "wires": [
            [
                "fc54472d.a4ef48"
            ]
        ],
        "info": "if a friendly name is set in the ui this needs to bee stored as well"
    },
    {
        "id": "72806b9a.0a0354",
        "type": "debug",
        "z": "364ae788.0e6328",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 850,
        "y": 100,
        "wires": []
    },
    {
        "id": "aecffc67.3d552",
        "type": "function",
        "z": "364ae788.0e6328",
        "name": "Save unknown devices",
        "func": "devices = global.get(\"LORIDANE.devices\")||{gw:[],nodes:[]};\nnewConfig = global.get(\"LORIDANE.classes.newConfig\");\ndata = msg.config;\ncheckUID = global.get(\"LORIDANE.funcs.checkUID\");\nblock = global.get(\"LORIDANE.blockONstart\");\nif(block){return;}\n\n//constructor(UID,type,freq,sf,friendlyname,interval,nextgw)\n\n// New Gateway?\nlet UID = data.gw;\nconst USER = global.get(\"LORIDANE.LinuxUsername\");\n\nlet newdevice = true;\nlet type = \"GW\";\n\nfor (var device in devices.gw){\n    /*\n    if(devices.gw.length === 0){\n        break;\n    }\n    //*/\n    if(devices.gw[device].uid == UID){\n        node.status({text:\"Known Device\"});\n        devices.gw[device].lastSeen = data.lastSeen || Date.now();\n        data.friendlyname = devices.gw[device].friendlyname;\n        newdevice = false;\n        changedConf = (devices.gw[device].freq != data.freq || devices.gw[device].sf != data.sf);\n        if (changedConf){\n            devices.gw[device].nextGW = data.gw;\n            devices.gw[device].freq = data.freq //\n            devices.gw[device].sf = data.sf//\n            conf = devices.gw[device];\n            node.send({/*payload:conf,filename:`/home/${USER}/loridaneHWconfig/gateways/${UID}.json`*/});\n            node.status({text:\"changed GW conf saved\"});\n        }\n    break;\n    }\n}\n\nif(newdevice && UID.startsWith(\"GW\") && checkUID(UID) && data.node != data.gw){\n        conf = new newConfig(UID,type,data.freq,data.sf,data.friendlygw,0,data.friendlygw);\n        devices.gw.push(conf);\n        node.send({/*payload:conf,filename:`/home/${USER}/loridaneHWconfig/gateways/${UID}.json`*/});\n}\n\n\n//New Node?\nnewdevice = true;\nUID = data.node;\ntype = \"energy\";\nfor (device in devices.nodes){\n    /*\n    if(devices.nodes.length === 0){\n        break;\n    }\n    //*/\n    if(devices.nodes[device].uid == UID){\n        devices.nodes[device].lastinterval = devices.nodes[device].interval;\n        devices.nodes[device].interval = data.lastSeen - devices.nodes[device].lastSeen;\n        devices.nodes[device].lastSeen = data.lastSeen;\n        //data.friendlyname = devices.nodes[device].friendlyname;\n        newdevice = false;\n        changedConf = (devices.nodes[device].freq != data.freq || devices.nodes[device].sf != data.sf || data.gw != devices.nodes[device].nextGW);\n        if (changedConf){ //  if it is not a new unknown uid it might be a changed configuration\n            devices.nodes[device].nextGW = data.gw;\n            devices.nodes[device].freq = data.freq //\n            devices.nodes[device].sf = data.sf//\n            conf = devices.nodes[device];\n            node.send({/*payload:conf,filename:`/home/${USER}/loridaneHWconfig/nodes/${UID}.json`*/});\n            node.status({text:\"changed conf saved\"});\n        }\n        break;\n    }\n}\nif(newdevice && UID.startsWith(\"NO\") && checkUID(UID)){\n    conf = new newConfig(UID,type,data.freq,data.sf,data.friendlyname,0,data.gw); //uses class definition for new device\n    conf.nextGW = data.gw;\n    conf.tx = 20;\n    devices.nodes.push(conf);\n    node.send({/*payload:conf,filename:`/home/${USER}/loridaneHWconfig/nodes/${UID}.json`*/});\n}\nsetTimeout(() => node.status({}),3000);\nmsg.config = devices;//data;\nglobal.set(\"LORIDANE.devices\",devices);\n\ntd = global.get(\"LORIDANE.timedisk\");\nif(td === undefined){\n    return null; // null is an empty object but triggers the timedisk function\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 240,
        "wires": [
            [
                "fc54472d.a4ef48"
            ]
        ],
        "info": "if a device is admitted and acknowledged it needs a saved configuration "
    },
    {
        "id": "fc54472d.a4ef48",
        "type": "function",
        "z": "364ae788.0e6328",
        "name": "write config file",
        "func": "if(msg.filename === undefined){return}\nconst fs = global.get(\"fs\");\nvar loridane =  global.get(\"LORIDANE\");\nconst configpath = loridane.settings.path.config;\n//delete loridane.timedisk;\n//delete loridane.homepath;\n//delete loridane.settings;\n//loridane.blockONstart = false;\nconst loridaneString = JSON.stringify(loridane,null,2);\nfs.writeFileSync(configpath+\"memCacheLoridane.json\",loridaneString)\nreturn {payload:loridane};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "// Der Code hier wird ausgeführt,\n// wenn der Node gestoppt wird\nconst fs = global.get(\"fs\");\nvar loridane =  global.get(\"LORIDANE\");\nconst configpath = loridane.settings.path.config;\n//delete loridane.timedisk;\ndelete loridane.homepath;\ndelete loridane.settings;\n//loridane.blockONstart = false;\nconst loridaneString = JSON.stringify(loridane,null,2);\nfs.writeFileSync(configpath+\"memCacheLoridane.json\",loridaneString)\nreturn {payload:loridane};",
        "libs": [],
        "x": 940,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "4caa54e54d0ec49a",
        "type": "change",
        "z": "364ae788.0e6328",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "LORIDANE.values.lastPayloadLens.minInterval",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "For the current parameters the minimum node interval is (ms):",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 575,
        "y": 180,
        "wires": [
            [
                "064c82486d9e8731"
            ]
        ],
        "l": false
    },
    {
        "id": "064c82486d9e8731",
        "type": "ui_text",
        "z": "364ae788.0e6328",
        "group": "4640ddc61a547a32",
        "order": 2,
        "width": "8",
        "height": "2",
        "name": "",
        "label": "{{msg.topic}}",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "className": "",
        "x": 700,
        "y": 180,
        "wires": []
    },
    {
        "id": "4640ddc61a547a32",
        "type": "ui_group",
        "name": "Last Reading",
        "tab": "278b2300.ae23ae",
        "order": 2,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "278b2300.ae23ae",
        "type": "ui_tab",
        "name": "Messages",
        "icon": "comment",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "20f0b4a8.24eafc",
        "type": "tab",
        "label": "LORIDANE",
        "disabled": false,
        "info": ""
    },
    {
        "id": "4936118b.229c4",
        "type": "group",
        "z": "20f0b4a8.24eafc",
        "name": "",
        "style": {
            "label": true,
            "fill": "#3FADB5",
            "fill-opacity": "0.26",
            "stroke": "#3FADB5"
        },
        "nodes": [
            "32bd7baa.d97b84",
            "f4bb67bd.d39b98",
            "8d9b21fb.c4275",
            "91387791.465208",
            "462cebc3.de6054",
            "8ed3f24e.7d554",
            "ae7a5c97.cc6aa",
            "96e88eff.65928",
            "84f194f0.98f118",
            "514c816a.24ad6",
            "48d31a4b.9b3544",
            "dcee77a5.339a48",
            "c2a7d48a.8b7dc8",
            "ba03182a.053b38",
            "a92d9ccf.7a839",
            "c6397117.2fd33",
            "b5c5836bfcd2b2f6",
            "23ee3a1a1df01ae6",
            "1405d54f20affd95",
            "96668ca0cec58e41",
            "e00e39905c1aa5d6",
            "28cda6992b8bfd08",
            "af944f0498c03cf8",
            "fcbca39c578599f1"
        ],
        "x": 114,
        "y": 179,
        "w": 1552,
        "h": 382
    },
    {
        "id": "862ff2cc.15c2e",
        "type": "inject",
        "z": "20f0b4a8.24eafc",
        "name": "Listen to 867Mhz for 10 secs",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "syncfrequency",
        "x": 320,
        "y": 140,
        "wires": [
            [
                "32bd7baa.d97b84"
            ]
        ]
    },
    {
        "id": "32bd7baa.d97b84",
        "type": "subflow:364ae788.0e6328",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "Save new devices",
        "env": [],
        "x": 850,
        "y": 380,
        "wires": [
            [
                "84f194f0.98f118",
                "91387791.465208",
                "96e88eff.65928"
            ]
        ]
    },
    {
        "id": "84f194f0.98f118",
        "type": "debug",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1110,
        "y": 380,
        "wires": []
    },
    {
        "id": "f4bb67bd.d39b98",
        "type": "subflow:4e984df.de567b4",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 240,
        "y": 400,
        "wires": [
            [
                "c6397117.2fd33",
                "8d9b21fb.c4275",
                "a92d9ccf.7a839",
                "48d31a4b.9b3544"
            ],
            [
                "dcee77a5.339a48",
                "0f3d9665ab58dfab"
            ],
            [
                "c2a7d48a.8b7dc8"
            ]
        ]
    },
    {
        "id": "8d9b21fb.c4275",
        "type": "subflow:6712fbef.2d8494",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 520,
        "y": 380,
        "wires": [
            [
                "32bd7baa.d97b84",
                "74e3460a.4c1b38"
            ]
        ]
    },
    {
        "id": "c6397117.2fd33",
        "type": "debug",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "config",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 370,
        "y": 220,
        "wires": []
    },
    {
        "id": "91387791.465208",
        "type": "subflow:ada10296.06249",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 980,
        "y": 520,
        "wires": [
            [
                "462cebc3.de6054",
                "659d2117.5091"
            ]
        ]
    },
    {
        "id": "36868927.261126",
        "type": "inject",
        "z": "20f0b4a8.24eafc",
        "name": "New timedisk manual trigger",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "10",
        "topic": "",
        "payloadType": "date",
        "x": 880,
        "y": 580,
        "wires": [
            [
                "91387791.465208"
            ]
        ]
    },
    {
        "id": "462cebc3.de6054",
        "type": "subflow:2fad0fdc.1d24b",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 1240,
        "y": 520,
        "wires": []
    },
    {
        "id": "a92d9ccf.7a839",
        "type": "debug",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "Complete Raw MSG",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 400,
        "y": 260,
        "wires": []
    },
    {
        "id": "74e3460a.4c1b38",
        "type": "debug",
        "z": "20f0b4a8.24eafc",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 570,
        "y": 620,
        "wires": []
    },
    {
        "id": "8ed3f24e.7d554",
        "type": "subflow:1395c386.064e8c",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 1040,
        "y": 220,
        "wires": []
    },
    {
        "id": "ae7a5c97.cc6aa",
        "type": "comment",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "Core Functions",
        "info": "",
        "x": 720,
        "y": 220,
        "wires": []
    },
    {
        "id": "659d2117.5091",
        "type": "debug",
        "z": "20f0b4a8.24eafc",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1190,
        "y": 580,
        "wires": []
    },
    {
        "id": "96e88eff.65928",
        "type": "subflow:922120e5.5b086",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 850,
        "y": 420,
        "wires": [
            [
                "32bd7baa.d97b84"
            ]
        ]
    },
    {
        "id": "514c816a.24ad6",
        "type": "subflow:c23de0ef.dae5f",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 1260,
        "y": 220,
        "wires": []
    },
    {
        "id": "48d31a4b.9b3544",
        "type": "subflow:d7577d7f.0f9b4",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 520,
        "y": 320,
        "wires": []
    },
    {
        "id": "dcee77a5.339a48",
        "type": "link out",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "LORIDANE - Payload Out",
        "links": [
            "1b5f4c28.4087d4",
            "bb1f1568.14d978",
            "9316dcde.92d3b",
            "79c2e88c5c7fd872",
            "7d50ce048626137a",
            "f94736f23109f93d",
            "1405d54f20affd95"
        ],
        "x": 405,
        "y": 480,
        "wires": []
    },
    {
        "id": "f4f736ad.a815a8",
        "type": "mqtt out",
        "z": "20f0b4a8.24eafc",
        "name": "test Node",
        "topic": "lora/gateway/",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "3be33484.0e776c",
        "x": 440,
        "y": 80,
        "wires": []
    },
    {
        "id": "d7c76a27.821278",
        "type": "inject",
        "z": "20f0b4a8.24eafc",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payloadType": "date",
        "x": 160,
        "y": 80,
        "wires": [
            [
                "943b015b.8fc56"
            ]
        ]
    },
    {
        "id": "943b015b.8fc56",
        "type": "function",
        "z": "20f0b4a8.24eafc",
        "name": "emulate node",
        "func": "function randval(min,max){\n    return min+Math.random()*(max-min);\n}\n\nmsg.payload = `{\"payload\":\"NO1234567890AB${Math.round(randval(1,2000000))/100}\",\\\n\"gw\":\"GW1234567890AB\",\\\n\"rssi\":${Math.round(randval(-120,0))},\\\n\"snr\":${Math.round(randval(-10,12))},\\\n\"sf\":7,\\\n\"freq\":867000000}`;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 315,
        "y": 80,
        "wires": [
            [
                "f4f736ad.a815a8",
                "4782ee921ccea2a0"
            ]
        ],
        "l": false
    },
    {
        "id": "c2a7d48a.8b7dc8",
        "type": "link out",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "trigger TD",
        "links": [
            "ba03182a.053b38"
        ],
        "x": 395,
        "y": 520,
        "wires": []
    },
    {
        "id": "ba03182a.053b38",
        "type": "link in",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "trigger new TD in",
        "links": [
            "c2a7d48a.8b7dc8"
        ],
        "x": 775,
        "y": 520,
        "wires": [
            [
                "91387791.465208"
            ]
        ]
    },
    {
        "id": "b5c5836bfcd2b2f6",
        "type": "subflow:f74e4d3b7750f42f",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 1050,
        "y": 280,
        "wires": []
    },
    {
        "id": "23ee3a1a1df01ae6",
        "type": "subflow:b9c36c50122d3534",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 1260,
        "y": 280,
        "wires": []
    },
    {
        "id": "1405d54f20affd95",
        "type": "link in",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "links": [
            "dcee77a5.339a48"
        ],
        "x": 875,
        "y": 280,
        "wires": [
            [
                "b5c5836bfcd2b2f6",
                "96668ca0cec58e41"
            ]
        ]
    },
    {
        "id": "e00e39905c1aa5d6",
        "type": "debug",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1250,
        "y": 340,
        "wires": []
    },
    {
        "id": "96668ca0cec58e41",
        "type": "subflow:b5aa0f5765475d21",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 1040,
        "y": 340,
        "wires": [
            [
                "e00e39905c1aa5d6",
                "b40fd1cddada2fce"
            ]
        ]
    },
    {
        "id": "4782ee921ccea2a0",
        "type": "debug",
        "z": "20f0b4a8.24eafc",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 466,
        "y": 27,
        "wires": []
    },
    {
        "id": "28cda6992b8bfd08",
        "type": "subflow:70c78cdd2a465aeb",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 1595,
        "y": 380,
        "wires": [
            [
                "462cebc3.de6054"
            ]
        ],
        "l": false
    },
    {
        "id": "af944f0498c03cf8",
        "type": "subflow:69345ed8c4c13255",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "env": [],
        "x": 1540,
        "y": 280,
        "wires": []
    },
    {
        "id": "e6cba7b752dfa8d9",
        "type": "inject",
        "z": "20f0b4a8.24eafc",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payloadType": "date",
        "x": 1173,
        "y": 413,
        "wires": [
            []
        ]
    },
    {
        "id": "fcbca39c578599f1",
        "type": "ui_button",
        "z": "20f0b4a8.24eafc",
        "g": "4936118b.229c4",
        "name": "",
        "group": "06efc03a6ebef2e8",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Export Node Data as CSV",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "",
        "payloadType": "date",
        "topic": "topic",
        "topicType": "msg",
        "x": 1530,
        "y": 220,
        "wires": [
            [
                "af944f0498c03cf8"
            ]
        ]
    },
    {
        "id": "ab70ae9f951a3207",
        "type": "ui_button",
        "z": "20f0b4a8.24eafc",
        "name": "",
        "group": "b27ef2892ca432db",
        "order": 9,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Nodes Send Unblock",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "false",
        "payloadType": "bool",
        "topic": "topic",
        "topicType": "msg",
        "x": 1460,
        "y": 340,
        "wires": [
            [
                "28cda6992b8bfd08"
            ]
        ]
    },
    {
        "id": "02d403b807b75bcf",
        "type": "ui_button",
        "z": "20f0b4a8.24eafc",
        "name": "",
        "group": "b27ef2892ca432db",
        "order": 9,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Nodes Sendblock",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "",
        "payload": "true",
        "payloadType": "bool",
        "topic": "topic",
        "topicType": "msg",
        "x": 1440,
        "y": 380,
        "wires": [
            [
                "28cda6992b8bfd08"
            ]
        ]
    },
    {
        "id": "0f3d9665ab58dfab",
        "type": "debug",
        "z": "20f0b4a8.24eafc",
        "name": "Complete Processed MSG",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 320,
        "y": 620,
        "wires": []
    },
    {
        "id": "b40fd1cddada2fce",
        "type": "mqtt out",
        "z": "20f0b4a8.24eafc",
        "name": "Hassio Forward",
        "topic": "loridane/forwarded",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "58249eec39689acc",
        "x": 1550,
        "y": 620,
        "wires": []
    },
    {
        "id": "1af0b3c079262f99",
        "type": "tab",
        "label": "Test Configuration",
        "disabled": false,
        "info": ""
    },
    {
        "id": "63e47da1f9857765",
        "type": "group",
        "z": "1af0b3c079262f99",
        "name": "",
        "style": {
            "fill": "#ffff3f",
            "fill-opacity": "0.31",
            "label": true
        },
        "nodes": [
            "a1a588ae060f4be2",
            "b054592db5217291",
            "32e50cec2a65d0a8",
            "ccc64aa93b36536c",
            "2f23e8e6bd507d86",
            "48b75b95bfd31997",
            "1c79dd3d34c7a0ba",
            "d262249028fe3770",
            "d1508a2c6045c1a0",
            "123617ddd7956c39",
            "71ac9419e3e9f5d6",
            "b2bc4cfbd2564847",
            "31e3448cc87e8765"
        ],
        "x": 54,
        "y": 99,
        "w": 792,
        "h": 422
    },
    {
        "id": "a1a588ae060f4be2",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "lora/GWF008D1C8D658",
        "payload": "fn:8650;fg:8650;",
        "payloadType": "str",
        "x": 200,
        "y": 400,
        "wires": [
            [
                "ccc64aa93b36536c"
            ]
        ]
    },
    {
        "id": "b054592db5217291",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "lora/GWF008D1C8D658",
        "payload": "fn:8670;cn:cg:fg:8670;",
        "payloadType": "str",
        "x": 320,
        "y": 440,
        "wires": [
            [
                "ccc64aa93b36536c"
            ]
        ]
    },
    {
        "id": "32e50cec2a65d0a8",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "lora/GWF008D1C8D658",
        "payload": "cn:cg:fn:8640;fg:8640;",
        "payloadType": "str",
        "x": 320,
        "y": 480,
        "wires": [
            [
                "ccc64aa93b36536c"
            ]
        ]
    },
    {
        "id": "ccc64aa93b36536c",
        "type": "subflow:2fad0fdc.1d24b",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "env": [],
        "x": 560,
        "y": 400,
        "wires": []
    },
    {
        "id": "2f23e8e6bd507d86",
        "type": "debug",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 730,
        "y": 240,
        "wires": []
    },
    {
        "id": "48b75b95bfd31997",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "11",
        "topic": "lora/GWF008D1C8D658",
        "payload": "NO84CCA84ADF70iv:507",
        "payloadType": "str",
        "x": 230,
        "y": 180,
        "wires": [
            [
                "ccc64aa93b36536c"
            ]
        ],
        "info": "Sends Timesync to Nodes"
    },
    {
        "id": "1c79dd3d34c7a0ba",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "lora/GWF008D1C8D658",
        "payload": "cn:iv:600000;",
        "payloadType": "str",
        "x": 370,
        "y": 360,
        "wires": [
            [
                "ccc64aa93b36536c"
            ]
        ]
    },
    {
        "id": "d262249028fe3770",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "lora/GWF008D1C8D658",
        "payload": "cn:iv:306;",
        "payloadType": "str",
        "x": 360,
        "y": 280,
        "wires": [
            [
                "ccc64aa93b36536c"
            ]
        ]
    },
    {
        "id": "d1508a2c6045c1a0",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "lora/GWF008D1C8D658",
        "payload": "cn:sync;",
        "payloadType": "str",
        "x": 610,
        "y": 200,
        "wires": [
            [
                "2f23e8e6bd507d86",
                "ccc64aa93b36536c"
            ]
        ]
    },
    {
        "id": "123617ddd7956c39",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "lora/GW94B97EC0C31C",
        "payload": "cn:iv:15000;",
        "payloadType": "str",
        "x": 370,
        "y": 320,
        "wires": [
            [
                "ccc64aa93b36536c"
            ]
        ]
    },
    {
        "id": "71ac9419e3e9f5d6",
        "type": "comment",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "Test Configuration Downlink",
        "info": "",
        "x": 500,
        "y": 140,
        "wires": []
    },
    {
        "id": "b2bc4cfbd2564847",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "lora/GW94B97EC0C31C",
        "payload": "cn:iv:100;",
        "payloadType": "str",
        "x": 320,
        "y": 240,
        "wires": [
            [
                "ccc64aa93b36536c"
            ]
        ]
    },
    {
        "id": "31e3448cc87e8765",
        "type": "inject",
        "z": "1af0b3c079262f99",
        "g": "63e47da1f9857765",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "11",
        "topic": "lora/GWF008D1C8D658",
        "payload": "NO84CCA84ADF70iv:5000",
        "payloadType": "str",
        "x": 210,
        "y": 140,
        "wires": [
            [
                "ccc64aa93b36536c"
            ]
        ],
        "info": "Sends Timesync to Nodes"
    },
    {
        "id": "0b3f1702fe1b5fd1",
        "type": "tab",
        "label": "Beispiel Tasks",
        "disabled": false,
        "info": ""
    },
    {
        "id": "f94736f23109f93d",
        "type": "link in",
        "z": "0b3f1702fe1b5fd1",
        "name": "Data Processing in",
        "links": [
            "dcee77a5.339a48"
        ],
        "x": 215,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "9a4d4e82a5b5ba18",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "Filter Nodes ONRO",
        "func": "\nnodes = [\n    \"NO94B97EC0C46C\",\n    //\"NO:94:B9:7E:C0:C3:1C\"\n    ];\n\nif (nodes.indexOf(msg.data.node) == -1){\n    return;\n}\n\npay = msg.payload.split(\";\");\n\nif(pay[0] == \"+\"){\n    return;\n}\nwatthours = parseFloat(pay[0])\nwatts = parseFloat(pay[1])\nmsg.payload = {watts:watts,watthours:watthours};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 220,
        "wires": [
            [
                "875c4592db053187",
                "794cede76b4e513c"
            ]
        ]
    },
    {
        "id": "794cede76b4e513c",
        "type": "debug",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 630,
        "y": 180,
        "wires": []
    },
    {
        "id": "341e0c2042b878f7",
        "type": "ui_gauge",
        "z": "0b3f1702fe1b5fd1",
        "name": "Leistung ONRO",
        "group": "bf837bc6.2c47f8",
        "order": 4,
        "width": 6,
        "height": 4,
        "gtype": "gage",
        "title": "Leistung - ONRO Zähler",
        "label": "Watt",
        "format": "{{value|number:2}}",
        "min": 0,
        "max": "1000",
        "colors": [
            "#3fadb5",
            "#3fadb5",
            "#3fadb5"
        ],
        "seg1": "",
        "seg2": "",
        "x": 1080,
        "y": 260,
        "wires": []
    },
    {
        "id": "875c4592db053187",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "Set DataSet",
        "func": "if(msg.topic == \"offset\"){\n    UID = msg.data.node\n    reading = parseFloat(msg.payload.set.replace(\",\",\".\"));\n    power = 0;\n    global.set(`LORIDANE.data.${UID}.lastreading`,reading);\n    return;\n}\n//if (isNaN(msg.payload)){return}\ndata = msg.data\nUID = data.node;\ntime = new Date(data.lastSeen)||new Date.now();\nshowtime = time.toLocaleString(\"de-DE\");\ndate = time.toISOString().substr(0,7);\nUSER = global.get(\"LORIDANE.LinuxUsername\")\nwriteConfig = global.get(\"LORIDANE.funcs.writeConfig\");\n\n//----------------------------------------\n//Calc power\nfunction getpower(input){\n    const now = Date.now();\n    const lasttime = flow.get(`data.${UID}.lasttime`)||0;\n    flow.set(`data.${UID}.lasttime`,now);\n    const msInhours = 3600000;\n\n    interval = now-lasttime;\n    ivperhour= msInhours / interval;\n    value = Math.round(input * ivperhour*100)/100;\n\n    if(value > 55000){\n        return;\n    }\n    return value;\n}\n//------------------------------------------\n//set object\nlastreading = global.get(`LORIDANE.data.${UID}.lastreading`)||0;\nreading = lastreading + (msg.payload.watthours/1000);\nconst obj = {\n    reading : reading,\n    power : msg.payload.watts,\n    timestamp : data.lastSeen,\n    time:showtime,\n    powerunit: \"Watt\",\n    readingunit: \"kWh\"\n}\nif(obj.reading > 0)global.set(`LORIDANE.data.${UID}.lastreading`,reading);\nif(obj.reading !== null && obj.power !== null){\n    msg.filename = `/home/${USER}/LORIDANE/database/${UID}/${UID}_${date}.json`;\n    writeConfig();\n}\nmsg.payload = obj;\n\nreturn;//  msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 260,
        "wires": [
            [
                "441a7d5bc511a0d6",
                "dd6a64904417ce22"
            ]
        ]
    },
    {
        "id": "f2212b2bb405c4e0",
        "type": "ui_chart",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "group": "bf837bc6.2c47f8",
        "order": 12,
        "width": 8,
        "height": 4,
        "label": "Letzte 12 Stunden",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "12",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "x": 1090,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "97f9b0ba4169a7c4",
        "type": "inject",
        "z": "0b3f1702fe1b5fd1",
        "name": "clear",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "[]",
        "payloadType": "json",
        "x": 910,
        "y": 300,
        "wires": [
            [
                "f2212b2bb405c4e0"
            ]
        ]
    },
    {
        "id": "441a7d5bc511a0d6",
        "type": "debug",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 810,
        "y": 180,
        "wires": []
    },
    {
        "id": "cbf1cf038c1d89f9",
        "type": "change",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload.power",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 935,
        "y": 260,
        "wires": [
            [
                "f2212b2bb405c4e0",
                "341e0c2042b878f7"
            ]
        ],
        "l": false
    },
    {
        "id": "26987baf40d07fb8",
        "type": "ui_button",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "group": "bf837bc6.2c47f8",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Clear View",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "fa-trash-o",
        "payload": "[]",
        "payloadType": "json",
        "topic": "clear",
        "topicType": "str",
        "x": 910,
        "y": 340,
        "wires": [
            [
                "f2212b2bb405c4e0"
            ]
        ]
    },
    {
        "id": "aff050996ded7495",
        "type": "inject",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "data.node",
                "v": "NO94B97EC0C46C",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "offset",
        "payload": "60.51",
        "payloadType": "num",
        "x": 390,
        "y": 260,
        "wires": [
            [
                "875c4592db053187"
            ]
        ]
    },
    {
        "id": "9ea57777d5a154c0",
        "type": "ui_text",
        "z": "0b3f1702fe1b5fd1",
        "group": "bf837bc6.2c47f8",
        "order": 2,
        "width": 8,
        "height": 2,
        "name": "",
        "label": "Zählerstand",
        "format": "{{msg.payload.reading|number:2}} kWh",
        "layout": "col-center",
        "className": "",
        "x": 1070,
        "y": 220,
        "wires": []
    },
    {
        "id": "49acfb51aeafe31b",
        "type": "change",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "data.node",
                "pt": "msg",
                "to": "NO94B97EC0C46C",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "offset",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 545,
        "y": 340,
        "wires": [
            [
                "875c4592db053187"
            ]
        ],
        "l": false
    },
    {
        "id": "860b565ea04d491e",
        "type": "ui_form",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "label": "Zählerstand Setzen",
        "group": "bf837bc6.2c47f8",
        "order": 13,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "68.23 (kWh)",
                "value": "set",
                "type": "text",
                "required": true,
                "rows": null
            }
        ],
        "formValue": {
            "set": ""
        },
        "payload": "",
        "submit": "Submit",
        "cancel": "Cancel",
        "topic": "topic",
        "topicType": "msg",
        "splitLayout": "",
        "x": 270,
        "y": 320,
        "wires": [
            [
                "49acfb51aeafe31b"
            ]
        ]
    },
    {
        "id": "8c7cd00fb6e1477a",
        "type": "inject",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "NO94B97EC0C46C.json",
        "payloadType": "str",
        "x": 290,
        "y": 540,
        "wires": [
            [
                "50d83ef34d804ebd"
            ]
        ]
    },
    {
        "id": "f26731381eb527ee",
        "type": "debug",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1210,
        "y": 520,
        "wires": []
    },
    {
        "id": "50d83ef34d804ebd",
        "type": "exec",
        "z": "0b3f1702fe1b5fd1",
        "command": "tail -5 /home/pi/LORIDANE/database/NO94B97EC0C46C/NO94B97EC0C46C_2021-10.json",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 760,
        "y": 540,
        "wires": [
            [
                "f26731381eb527ee"
            ],
            [],
            []
        ]
    },
    {
        "id": "dd6a64904417ce22",
        "type": "switch",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "property": "data.node",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "NO94B97EC0C46C",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 790,
        "y": 260,
        "wires": [
            [
                "cbf1cf038c1d89f9",
                "9ea57777d5a154c0"
            ]
        ]
    },
    {
        "id": "d70a412cf5ea38b1",
        "type": "comment",
        "z": "0b3f1702fe1b5fd1",
        "name": "example: show filtered device on dashboard",
        "info": "",
        "x": 310,
        "y": 140,
        "wires": []
    },
    {
        "id": "7748af2bad8d0612",
        "type": "comment",
        "z": "0b3f1702fe1b5fd1",
        "name": "example: read last 5 lines of database",
        "info": "",
        "x": 310,
        "y": 480,
        "wires": []
    },
    {
        "id": "53e53fc1526674a7",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "set ClassA devs",
        "func": "arr = [\"NOF008D1C8DC20\"];\nglobal.set(\"LORIDANE.classA\",arr);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 720,
        "wires": [
            [
                "3e8c6e2911401b56"
            ]
        ]
    },
    {
        "id": "c084d32605d97bb5",
        "type": "inject",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "5",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 230,
        "y": 720,
        "wires": [
            [
                "53e53fc1526674a7"
            ]
        ]
    },
    {
        "id": "3e8c6e2911401b56",
        "type": "debug",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 720,
        "wires": []
    },
    {
        "id": "1010ef439848f0a2",
        "type": "comment",
        "z": "0b3f1702fe1b5fd1",
        "name": "Example add Class A Device to Config",
        "info": "",
        "x": 300,
        "y": 680,
        "wires": []
    },
    {
        "id": "1d20ac9a4a7e3796",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "load file to obj array",
        "func": "fs = global.get(\"fs\"); // equals fs = require('fs')\nconst path = msg.filepath;\nfile = fs.readFileSync(path,'utf-8').split(\"\\n\");\nfile.splice(file.length - 1,1);\nlet data = [];\nfile.forEach(element => data.push(JSON.parse(element)));\nconst keys = Object.keys(data[0]);\n\nfor(var element in data){\n    for(var key of keys){\n        if (data[element][key] == null || data[element][key] == \"inf\"){\n            data.splice(element,1);\n            break;\n        }\n    }\n}\n\nmsg.data = data;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 920,
        "wires": [
            [
                "e023d10b18a488ed",
                "bd98a9deb4594960"
            ]
        ]
    },
    {
        "id": "3b7e7d70b0d24d94",
        "type": "inject",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 220,
        "y": 920,
        "wires": [
            [
                "c416bb47d58e7e1d"
            ]
        ]
    },
    {
        "id": "c416bb47d58e7e1d",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "define filepath",
        "func": "path = global.get(\"LORIDANE.settings.path.database\");\nnow = Date.now();\ntime = new Date(now);\ndate = time.toISOString().substr(0,7);\nUID = \"NO94B97EC0C46C\";\npath = path+ `${UID}/${UID}_${date}.json`;\n//node.warn(path)\nmsg.params = {\n    starttime: Date.now() - 24*60*60*1000,\n    interval: 24*60*60*1000,\n    costPerKwh: 0.283,\n};\n\n\nmsg.filepath = path;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 920,
        "wires": [
            [
                "1d20ac9a4a7e3796"
            ]
        ]
    },
    {
        "id": "854799d168173f31",
        "type": "debug",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1070,
        "y": 920,
        "wires": []
    },
    {
        "id": "e023d10b18a488ed",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "mean power by time",
        "func": "const interval = msg.params.interval;\nconst starttime = msg.params.starttime;\nconst endtime = starttime + interval;\nconst costPerKwh = msg.params.costPerKwh;\nlet data = msg.data;\nconst IRO = global.get(\"LORIDANE.funcs.inRangeOf\");\nlet powers = [];\nlet timespan = [];\nmsg.out = {};\n\n//set property Key here\nconst powerKey = 'measure1';\n\nfor (i = 0; i<data.length;i++){\n    if(IRO(data[i].timestamp,starttime,endtime)){\n        if (!isNaN(data[i][powerKey])){\n            timespan.push(data[i].timestamp);\n            powers.push(parseFloat(data[i][powerKey]));\n        }\n    }\n}\n\nspan = timespan[timespan.length-1] - timespan[0];\n\nfor (i = 1; i < powers.length; i++){\n    powers[i] *= (timespan[i] - timespan[i-1]);\n}\n\n//node.warn(powers)\npower = powers.reduce((left,right) => left + right);\npower /=  span;\n\n\nmsg.out.powers = powers;\nmsg.out.meanPower  = power;\ncost = power/1000 * costPerKwh * span/36e5;\nmsg.out.costPerInterval = cost;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 920,
        "wires": [
            [
                "854799d168173f31"
            ]
        ]
    },
    {
        "id": "bd98a9deb4594960",
        "type": "debug",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 930,
        "y": 860,
        "wires": []
    },
    {
        "id": "0c57848173652fb4",
        "type": "comment",
        "z": "0b3f1702fe1b5fd1",
        "name": "Example Read DB and calc cost for a given time interval",
        "info": "",
        "x": 350,
        "y": 860,
        "wires": []
    },
    {
        "id": "9828211879842201",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "load file to obj array",
        "func": "fs = global.get(\"fs\");\npath = msg.filepath;\nfile = fs.readFileSync(path,'utf-8').split(\"\\n\");\nfile.splice(file.length - 1,1);\ndata = [];\nfile.forEach(element => data.push(JSON.parse(element)));\nkeys = Object.keys(data[0]);\n\nfor(var element in data){\n    for(var key of keys){\n        if (data[element][key] == null){\n            data.splice(element,1);\n            break;\n        }\n    }\n}\n\nmsg.data = data;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 1120,
        "wires": [
            [
                "67e7dc8e5e0d33a7"
            ]
        ]
    },
    {
        "id": "0c56b64aec0280ad",
        "type": "inject",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 220,
        "y": 1080,
        "wires": [
            [
                "2989d1d20b53779c"
            ]
        ]
    },
    {
        "id": "2989d1d20b53779c",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "define filepath",
        "func": "//path = global.get(\"LORIDANE.settings.path.database\");\nnow = Date.now();\ntime = new Date(now);\ndate = time.toISOString().substr(0,10);\nUID = \"NO94B97EC0C46C\";\npath = `/home/pi/LORIDANE/database/NO94B97EC0C46C/NO94B97EC0C46C_2021-09.json`;\n//node.warn(path)\nmsg.params = {\n    starttime: 0,//Date.now() - 24*60*60*1000,\n    interval: Infinity,\n    costPerKwh: 0.283,\n};\n\n\nmsg.filepath = path;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 1080,
        "wires": [
            [
                "9828211879842201"
            ]
        ]
    },
    {
        "id": "226074b1e1dd6c3b",
        "type": "debug",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1190,
        "y": 1020,
        "wires": []
    },
    {
        "id": "67e7dc8e5e0d33a7",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "delete unrequired property",
        "func": "data = msg.data\nstarttime = data[0].timestamp\nlet count = 1\nfor(var date of data){\n    delete date.reading\n    delete date.powerunit\n    delete date.readingunit\n    delete date.time\n    date.reltime = date.timestamp - starttime;\n    date.id = \"R\"+count;\n    count++;\n}\nmsg.data = data;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 1160,
        "wires": [
            [
                "7b804f9ff2308e9f"
            ]
        ]
    },
    {
        "id": "7b804f9ff2308e9f",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "process labels",
        "func": "data = msg.data\niro = global.get(\"LORIDANE.funcs.inRangeOf\");\n\nfor(var i in data){\n    if(iro(data[i].power,0,47)){\n        data[i].pid = \"idle\"\n    }else if(iro(data[i].power,47,52.5)){\n        data[i].pid = \"downstream\"\n    }else if(iro(data[i].power,52.5,10)){\n        data[i].pid = \"upstream\"\n    }else if(iro(data[i].power,55,1000)){\n        data[i].pid = \"calculation\"\n    }\n}\nmsg.data = data;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 1200,
        "wires": [
            [
                "1c032af464f2e330"
            ]
        ]
    },
    {
        "id": "1c032af464f2e330",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "calculate duration",
        "func": "data = msg.data\nlen = data.length\ndata[0].dur = 0;\nfor(i=1;i<len;i++){\n    data[i].dur = Math.round((data[i].reltime - data[i-1].reltime)/1e3);\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 1240,
        "wires": [
            [
                "8babc9f33f594710",
                "f91cb91215f9d412"
            ]
        ]
    },
    {
        "id": "8babc9f33f594710",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "objects to json file",
        "func": "for (var date of msg.data){\n    node.send({payload:date})\n}\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 1240,
        "wires": [
            [
                "18b06a85b8a73543"
            ]
        ]
    },
    {
        "id": "18b06a85b8a73543",
        "type": "file",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "filename": "/home/pi/LORIDANE/outdata/fileserver_202109_processed.json",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "none",
        "x": 1370,
        "y": 1240,
        "wires": [
            []
        ]
    },
    {
        "id": "57fd659f2ac85919",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "convergence matrix to csv",
        "func": "data = msg.data;\nlen = data.length\nfirstline = \"\";\n\nfunction getEdge(bar1,bar2){\n    let edgeweight = 0;\n    let interval = bar2.reltime - bar1.reltime\n    if(bar1.reltime == bar2.reltime)return 0;\n    if(Math.abs(interval > 600000))return 0;\n    //compare power\n        if(bar1.pid == bar2.pid){\n        edgeweight += 1;\n    }\n    if((bar1.pstart && bar2.pstart) ||(bar1.pstart === false && bar2.pstart === false)){\n        edgeweight += 2;\n    }\n    if(Math.abs(interval < 600000)){\n        edgeweight += interval/1e4;\n    }\n    return edgeweight;\n}\n\nfor(var date of data){\n    append = \";\"+date.id;\n    firstline += append\n}\nnode.send({payload:firstline});\n\nfor (i=0;i<len;i++){\n    output = \"\"\n    output += data[i].id\n    for(j=0;j<len;j++){\n       output += \";\"+getEdge(data[i],data[j]);\n    }\n    node.send({payload:output})\n}\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 1320,
        "wires": [
            [
                "24b1eca37384f932"
            ]
        ]
    },
    {
        "id": "24b1eca37384f932",
        "type": "file",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "filename": "/home/pi/LORIDANE/outdata/fileserver_202109_edges.csv",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "none",
        "x": 1380,
        "y": 1320,
        "wires": [
            []
        ]
    },
    {
        "id": "f91cb91215f9d412",
        "type": "function",
        "z": "0b3f1702fe1b5fd1",
        "name": "compare pid",
        "func": "data = msg.data\nlen = data.length;\ndata[0].pstart = true;\n\nfor (i = 2; i<len; i++){\n    if (data[i].pid != data[i-1].pid){\n        data[i].pstart = true\n        data[i-1].pstart = false\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 1280,
        "wires": [
            [
                "57fd659f2ac85919",
                "226074b1e1dd6c3b"
            ]
        ]
    },
    {
        "id": "70c5f41a4186d5d8",
        "type": "comment",
        "z": "0b3f1702fe1b5fd1",
        "name": "Prepare Data for statistical analysis including Covalence Matrix",
        "info": "",
        "x": 390,
        "y": 1020,
        "wires": []
    },
    {
        "id": "822f389b917b8cc5",
        "type": "debug",
        "z": "0b3f1702fe1b5fd1",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1530,
        "y": 1000,
        "wires": []
    },
    {
        "id": "06efc03a6ebef2e8",
        "type": "ui_group",
        "name": "Export Files",
        "tab": "1809f267.7a279e",
        "order": 8,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "b27ef2892ca432db",
        "type": "ui_group",
        "name": "Block Nodes",
        "tab": "1809f267.7a279e",
        "order": 7,
        "disp": true,
        "width": "8",
        "collapse": false,
        "className": ""
    },
    {
        "id": "58249eec39689acc",
        "type": "mqtt-broker",
        "name": "HASSIO",
        "broker": "192.168.2.113",
        "port": "1883",
        "clientid": "LORIDANE-02",
        "usetls": false,
        "protocolVersion": "3",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "loridane/offline/",
        "willQos": "0",
        "willPayload": "1",
        "willMsg": {},
        "sessionExpiry": ""
    }
]